<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Decision Stream - ì¤‘ê¸° ìŠ¤ìœ™ íˆ¬ì ì‹œìŠ¤í…œ</title>

<style>
:root{
  --bg:#0b1020; --panel:#12183a; --card:#151c45;
  --line:#24306a; --text:#e7ebff; --muted:#aab3d6;
  --ok:#52d27d; --warn:#ffb84d; --err:#ff4d4d; --accent:#4a90e2;
  --radius:14px;
}

* { box-sizing: border-box; }

body {
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
}

header {
  padding:16px 24px; border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
}

header h1 {
  font-size:20px; margin:0; font-weight:900;
}

.header-right {
  display:flex; gap:12px; align-items:center;
}

.pill {
  padding:6px 12px; border-radius:999px;
  background:#0f1730; color:var(--muted);
  font-size:12px; font-weight:600;
}

.pill.plan-free { background:#1a3a1a; color:#52d27d; }
.pill.plan-pro { background:#3a2a1a; color:#ffb84d; }
.pill.plan-elite { background:#3a1a2a; color:#ff4d4d; }

.container {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap:16px;
  padding:16px;
  max-width:1800px;
  margin:0 auto;
}

.card {
  background:linear-gradient(180deg, #141b45 0%, var(--card) 100%);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:16px;
  min-height:220px;
}

.card h3 {
  margin:0 0 12px 0;
  font-size:15px;
  color:#cdd6ff;
}

.small {
  font-size:12px;
  color:var(--muted);
}

.row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}

.badge {
  padding:4px 10px;
  border-radius:8px;
  font-size:11px;
  font-weight:700;
}

.badge.ok { background:#153f2a; color:var(--ok); }
.badge.warn { background:#3f2e15; color:var(--warn); }
.badge.err { background:#3f1515; color:var(--err); }

.list {
  display:flex;
  flex-direction:column;
  gap:8px;
}

.item {
  padding:10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#10174a;
  cursor:pointer;
  transition: all 0.2s;
}

.item:hover {
  border-color:#3a49a5;
  background:#1a2460;
}

.item.disabled {
  opacity:.4;
  cursor:not-allowed;
}

.item.disabled:hover {
  border-color:var(--line);
  background:#10174a;
}

.kv {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin:6px 0;
}

.sep {
  height:1px;
  background:var(--line);
  margin:12px 0;
}

button {
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #2e3a7a;
  background:#1a2460;
  color:#fff;
  cursor:pointer;
  font-weight:700;
  font-size:13px;
  width:100%;
  transition: all 0.2s;
}

button:hover {
  background:#2a3470;
}

button:disabled {
  opacity:.5;
  cursor:not-allowed;
}

button.secondary {
  background:#12183a;
  border-color:#1e2550;
}

button.danger {
  background:#5a1d2a;
  border-color:#7a2e3a;
}

.grid2 {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}

input, select {
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #2e3a7a;
  background:#0f1730;
  color:#fff;
  font-size:13px;
}

.footer {
  padding:16px 24px;
  border-top:1px solid var(--line);
  text-align:center;
  color:var(--muted);
  font-size:12px;
}

.hidden {
  display:none;
}

.loading {
  text-align:center;
  padding:20px;
  color:var(--muted);
}

@media (max-width: 1200px) {
  .container {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
}

@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr;
  }
  
  header {
    flex-direction:column;
    gap:12px;
  }
}
</style>
</head>

<body>

<header>
  <h1>ğŸ“Š Decision Stream</h1>
  <div class="header-right">
    <button onclick="window.open('youtube_script_generator.html', '_blank')" 
            style="padding:8px 16px; background:#5a2a3a; color:#ff9a9e; border:1px solid #8a4a5a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ¬ ìœ íŠœë¸Œ ëŒ€ë³¸
    </button>
    <button onclick="window.open('algorithm_structure.html', '_blank')" 
            style="padding:8px 16px; background:#2a3a4a; color:#90cdf4; border:1px solid #4a6a7a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ§® ì•Œê³ ë¦¬ì¦˜
    </button>
    <button onclick="window.open('news_filter.html', '_blank')" 
            style="padding:8px 16px; background:#3a4a2a; color:#90ee90; border:1px solid #5a7a4a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ“° ë‰´ìŠ¤ í•„í„°
    </button>
    <button onclick="window.open('user_guide.html', '_blank')" 
            style="padding:8px 16px; background:#2a3a5a; color:#90cdf4; border:1px solid #4a6a9a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ“š ì‚¬ìš© ê°€ì´ë“œ
    </button>
    <span class="pill">KR Â· US</span>
    <span class="pill">ì¤‘ê¸° ìŠ¤ìœ™</span>
    <span class="pill plan-free" id="user-plan">Î² v1.0</span>
  </div>
</header>

<div class="container">

  <!-- 1. Market Regime -->
  <div class="card">
    <h3>1) Market Regime</h3>
    <div class="row">
      <div class="small">ì‹œì¥ ìƒíƒœ</div>
      <span id="regime-badge" class="badge warn">ë¡œë”©ì¤‘</span>
    </div>
    <div class="sep"></div>
    <div class="kv"><span>Risk Score</span><b id="risk-score">-</b></div>
    <div class="kv"><span>Playbook</span><b id="playbook">-</b></div>
    <div class="sep"></div>
    <div class="small" style="color:var(--muted); font-size:11px; line-height:1.6; padding:8px; background:rgba(102,126,234,0.1); border-radius:6px; border-left:3px solid #667eea;">
      ğŸ’¡ <b>Risk-On</b> = ì‚¬ë„ ì£½ì§€ ì•Šì„ í™•ë¥ ì´ ë†’ë‹¤ (ë§¤ìˆ˜ ì‹ í˜¸ ì•„ë‹˜)<br>
      ğŸ’¡ <b>Risk-Off</b> = ì§„ì… ê¸ˆì§€ (ê¸°ì¡´ í¬ì§€ì…˜ ì†ì ˆ ê²€í† )
    </div>
    <div class="sep"></div>
    <div id="regime-desc" class="small"></div>
    <div class="sep"></div>
    <div id="market-intelligence" class="small" style="line-height:1.8; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;">
      <div class="loading">ì‹œì¥ ë¶„ì„ ë¡œë”©ì¤‘...</div>
    </div>
  </div>

  <!-- 2. Sector Heatmap -->
  <div class="card">
    <h3>2) Sector Heatmap</h3>
    <div class="small">SURGE ì„¹í„°ë§Œ í´ë¦­ ê°€ëŠ¥</div>
    <div class="sep"></div>
    <div class="list" id="sector-list">
      <div class="loading">ë°ì´í„° ë¡œë”©ì¤‘...</div>
    </div>
    <div class="sep"></div>
    <div id="sector-desc" class="small"></div>
  </div>

  <!-- 3. Stock Funnel -->
  <div class="card">
    <h3>3) Stock Funnel</h3>
    <div id="funnel-status" class="small">ì„¹í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="sep"></div>
    
    <div class="small" style="font-weight:700;">Leader (ì„ ë„ì£¼)</div>
    <div class="list" id="leader">
      <div class="small">-</div>
    </div>
    
    <div class="sep"></div>
    
    <div class="small" style="font-weight:700;">Follower (ì¶”ì¢…ì£¼)</div>
    <div class="list" id="follower">
      <div class="small">-</div>
    </div>
    
    <div class="sep"></div>
    <div id="funnel-desc" class="small"></div>
  </div>

</div>

<div class="footer">
  <p>íˆ¬ì íŒë‹¨ ë³´ì¡° ë„êµ¬ì…ë‹ˆë‹¤. ë§¤ìˆ˜Â·ë§¤ë„ ê¶Œìœ  ë° ìˆ˜ìµ ë³´ì¥ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
  <p>Â© 2026 Decision Stream - ì¤‘ê¸° ìŠ¤ìœ™ íˆ¬ì í”„ë ˆì„ì›Œí¬</p>
</div>

<script>
// ========== Configuration ==========
const USER_PLAN = "Î² v1.0"; // FREE | PRO | ELITE

// í™˜ê²½ ìë™ ê°ì§€
const isDevelopment = window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';

const API = isDevelopment 
  ? "http://127.0.0.1:8125" 
  : "https://decision-stream-backend.railway.app"; // âš ï¸ Railway ë°°í¬ í›„ ì‹¤ì œ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½

const ACCESS_KEY = "ds-test-2026";
const USE_MOCK_DATA = true; // â¬…ï¸ í•­ìƒ Mock ë°ì´í„° ì‚¬ìš© (í…ŒìŠ¤íŠ¸ìš©)

// ========== State ==========
let selectedSector = null;
let selectedStock = null;
let lastPlan = null;
let regimeData = null;
let sectorData = null;
let funnelData = null;

// ========== Helpers ==========
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const withKey = p => `${API}${p}${p.includes('?')?'&':'?'}key=${ACCESS_KEY}`;

// Mock ë°ì´í„°
const MOCK_DATA = {
  regime: {
    state: 'RISK_ON',
    score: 2,
    max_score: 3,
    playbook: 'ëˆŒë¦¼ ë§¤ìˆ˜ í—ˆê°€',
    factors: {
      breadth: true,     // ìƒìŠ¹:í•˜ë½ 1.3:1
      volatility: true,  // VKOSPI 18
      theme: false       // ì§€ì† í…Œë§ˆ 1ê°œ ë¯¸ë§Œ
    },
    note: 'Risk_ON = ì‚¬ë„ ì£½ì§€ ì•Šì„ í™•ë¥ ì´ ë†’ë‹¤',
    detail: {
      breadth_ratio: '1.3:1 (ìƒìŠ¹ 650, í•˜ë½ 500)',
      vkospi: 18,
      lasting_themes: ['ë°©ì‚°']
    }
  },
  sectors: [
    { sector: 'ë°©ì‚°', flow_score: 97, flow_signal: 'SURGE', duration: '2ì£¼ ì§€ì†' },
    { sector: 'í—¬ìŠ¤ì¼€ì–´', flow_score: 96, flow_signal: 'SURGE', duration: '1ì£¼ ì§€ì†' },
    { sector: 'AI ë°˜ë„ì²´', flow_score: 46, flow_signal: 'NORMAL', duration: '-' },
    { sector: 'ì „ë ¥', flow_score: 45, flow_signal: 'NORMAL', duration: '-' },
    { sector: 'ì—ë„ˆì§€', flow_score: 8, flow_signal: 'NORMAL', duration: '-' }
  ],
  funnels: {
    'ë°©ì‚°': {
      leader: [],
      follower: [
        { ticker: 'LMT', name: 'Lockheed Martin', price: 445.50 },
        { ticker: '012450', name: 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', price: 185000 }
      ],
      nogo: []
    },
    'í—¬ìŠ¤ì¼€ì–´': {
      leader: [
        { ticker: 'JNJ', name: 'Johnson & Johnson', price: 158.25 }
      ],
      follower: [
        { ticker: '207940', name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', price: 850000 },
        { ticker: '068270', name: 'ì…€íŠ¸ë¦¬ì˜¨', price: 175000 }
      ],
      nogo: []
    },
    'AI ë°˜ë„ì²´': {
      leader: [],
      follower: [
        { ticker: '005930', name: 'ì‚¼ì„±ì „ì', price: 75000 }
      ],
      nogo: []
    }
  },
  market_intelligence: {
    script: `í˜„ì¬ ì‹œì¥ì€ RISK_ON êµ­ë©´ì´ë©°, ìê¸ˆì´ ë°©ì‚°ê³¼ í—¬ìŠ¤ì¼€ì–´ ì„¹í„°ë¡œ ì§‘ì¤‘ë˜ê³  ìˆìŠµë‹ˆë‹¤.\n\në°©ì‚° ì„¹í„°ëŠ” 2ì£¼ì§¸ SURGE ì‹ í˜¸ë¥¼ ìœ ì§€í•˜ê³  ìˆìœ¼ë©°, Lockheed Martinê³¼ í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤ê°€ Followerë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.\n\nì „ëµ: ëˆŒë¦¼ ë§¤ìˆ˜ ëŒ€ê¸°. 20ì¼ì„  ì§€ì§€ í™•ì¸ í›„ ì§„ì…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
  }
};

const fetchJSON = async (url) => {
  // Mock ë°ì´í„° ì‚¬ìš©
  if (USE_MOCK_DATA) {
    console.log('ğŸ”µ Using Mock Data:', url);
    
    // ì¦‰ì‹œ ë°˜í™˜ (ë”œë ˆì´ ì œê±°)
    if (url.includes('/regime')) {
      console.log('âœ… Returning regime data');
      return MOCK_DATA.regime;
    }
    if (url.includes('/sectors')) {
      console.log('âœ… Returning sectors data');
      return MOCK_DATA.sectors;
    }
    if (url.includes('/funnel')) {
      const sector = url.match(/sector=([^&]+)/)?.[1];
      const decodedSector = decodeURIComponent(sector || '');
      console.log('âœ… Returning funnel data for:', decodedSector);
      return MOCK_DATA.funnels[decodedSector] || null;
    }
    if (url.includes('/market_intelligence')) {
      console.log('âœ… Returning market intelligence');
      return MOCK_DATA.market_intelligence;
    }
    if (url.includes('/checklist')) {
      return {
        'ê°€ê²© êµ¬ì¡°': true,
        'ìˆ˜ê¸‰ ì‹ í˜¸': true,
        'ë³€ë™ì„±': false,
        'ë¦¬ìŠ¤í¬': true
      };
    }
    if (url.includes('/nogo_report')) {
      return {
        reasons: ['ê³¼ì—´ ì‹ í˜¸ ê°ì§€', 'ê±°ë˜ëŸ‰ ê¸‰ì¦'],
        conclusion: 'ì§„ì… ê¸ˆì§€'
      };
    }
    if (url.includes('/plan')) {
      return {
        entry: { breakout: '100,000', pullback: '98,000' },
        stop_loss: '95,000',
        targets: ['105,000', '110,000'],
        position_size: '20%'
      };
    }
    
    console.warn('âš ï¸ No mock data for:', url);
    return null;
  }
  
  // ì‹¤ì œ API í˜¸ì¶œ
  try {
    console.log('ğŸŒ Fetching from API:', url);
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    console.log('âœ… API response:', data);
    return data;
  } catch (error) {
    console.error('âŒ API Error:', error);
    console.log('âš ï¸ Falling back to Mock Data');
    // API ì‹¤íŒ¨ ì‹œ Mock ë°ì´í„°ë¡œ í´ë°±
    return fetchJSON(url.replace(API, ''));
  }
};

// ========== 1. Market Regime ==========
async function loadRegime() {
  regimeData = await fetchJSON(withKey('/regime'));
  if (!regimeData) return;
  
  $('#playbook').innerText = regimeData.playbook || '-';
  
  // Risk Score í‘œì‹œ (3ì  ë§Œì )
  const scoreText = `${regimeData.score || 0} / ${regimeData.max_score || 3}`;
  $('#risk-score').innerText = scoreText;
  
  const badge = $('#regime-badge');
  badge.textContent = regimeData.state || 'UNKNOWN';
  badge.className = 'badge ' + (regimeData.state === 'RISK_ON' ? 'ok' : 'err');
  
  // 3ê°€ì§€ ê¸°ì¤€ í‘œì‹œ
  const factors = regimeData.factors || {};
  const factorText = `
    âœ“ Breadth (ì‹œì¥ í™•ì‚°): ${factors.breadth ? 'âœ…' : 'âŒ'}<br>
    âœ“ Volatility (ë³€ë™ì„± ì–µì œ): ${factors.volatility ? 'âœ…' : 'âŒ'}<br>
    âœ“ Theme (í…Œë§ˆ ì§€ì†): ${factors.theme ? 'âœ…' : 'âŒ'}
  `;
  
  $('#regime-desc').innerHTML = factorText;
  
  // ì‹œì¥ í•´ì„¤ ìë™ ìƒì„±
  generateMarketIntelligence();
}

// ========== 2. Sectors ==========
async function loadSectors() {
  const list = $('#sector-list');
  list.innerHTML = '';
  
  sectorData = await fetchJSON(withKey('/sectors'));
  if (!sectorData || sectorData.length === 0) {
    list.innerHTML = '<div class="small">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  const surge = [];
  sectorData.forEach(s => {
    const it = document.createElement('div');
    it.className = 'item';
    
    const isSurge = s.flow_signal === 'SURGE';
    if (isSurge) surge.push(s.sector);
    else it.classList.add('disabled');
    
    it.innerHTML = `
      <div class="row">
        <b>${s.sector}</b>
        <span class="badge ${isSurge ? 'ok' : 'warn'}">${s.flow_signal}</span>
      </div>
      <div class="small">Flow ${s.flow_score} Â· ${s.duration || '-'}</div>
    `;
    
    if (isSurge) {
      it.onclick = () => {
        $$('.item').forEach(el => el.style.borderColor = 'var(--line)');
        it.style.borderColor = '#3a49a5';
        loadFunnel(s.sector);
      };
    }
    
    list.appendChild(it);
  });
  
  $('#sector-desc').innerText = surge.length
    ? `í˜„ì¬ ìê¸ˆì´ ${surge.join(', ')} ì„¹í„°ë¡œ ì§‘ì¤‘.`
    : 'ëšœë ·í•œ ìê¸ˆ ì§‘ì¤‘ ì„¹í„° ì—†ìŒ.';
}

// ========== 3. Funnel ==========
async function loadFunnel(sector) {
  selectedSector = sector;
  $('#funnel-status').innerText = `ì„ íƒ ì„¹í„°: ${sector}`;
  
  $('#leader').innerHTML = '<div class="loading">ë¡œë”©ì¤‘...</div>';
  $('#follower').innerHTML = '<div class="loading">ë¡œë”©ì¤‘...</div>';
  
  funnelData = await fetchJSON(withKey(`/funnel?sector=${encodeURIComponent(sector)}`));
  
  if (!funnelData) {
    $('#leader').innerHTML = '<div class="small">ë°ì´í„° ì—†ìŒ</div>';
    $('#follower').innerHTML = '<div class="small">ë°ì´í„° ì—†ìŒ</div>';
    return;
  }
  
  const addStock = (boxId, stocks, isNoGo) => {
    const box = $(boxId);
    box.innerHTML = '';
    
    if (!stocks || stocks.length === 0) {
      box.innerHTML = '<div class="small">-</div>';
      return;
    }
    
    stocks.forEach(stock => {
      const it = document.createElement('div');
      it.className = 'item' + (isNoGo ? ' disabled' : '');
      it.innerHTML = `<b>${stock.name || stock.ticker}</b><br><small>${stock.ticker}</small>`;
      
      if (!isNoGo) {
        it.onclick = () => {
          // ì¢…ëª© í´ë¦­ ì‹œ trade_plan_simulation.htmlë¡œ ì´ë™
          const market = stock.ticker.length <= 4 && !/^[0-9]+$/.test(stock.ticker) ? 'US' : 'KR';
          const params = new URLSearchParams({
            market: market,
            sector: sector,
            ticker: stock.ticker,
            name: stock.name || stock.ticker,
            price: stock.price || 0,
            risk: 'middle',
            period: 'ì¤‘ê¸°',
            capital: market === 'US' ? 10000 : 5000000
          });
          
          window.location.href = `trade_plan_simulation.html?${params.toString()}`;
        };
      }
      
      box.appendChild(it);
    });
  };
  
  addStock('#leader', funnelData.leader, false);
  addStock('#follower', funnelData.follower, false);
  
  $('#funnel-desc').innerText = funnelData.leader && funnelData.leader.length
    ? 'ì„ ë„ì£¼ í˜•ì„±. ëˆŒë¦¼ ë§¤ìˆ˜ êµ¬ê°„.'
    : funnelData.follower && funnelData.follower.length
    ? 'ì„¹í„°ëŠ” ê°•í•˜ë‚˜ ì•„ì§ ëŒíŒŒ ì „.'
    : 'ë§¤ìˆ˜ í™•ë¥ ì´ ë‚®ì€ ì„¹í„°.';
}

// ========== Market Intelligence (ìë™ ìƒì„± - ì „ë¬¸ê°€ ìˆ˜ì¤€ ë¶„ì„) ==========
async function generateMarketIntelligence() {
  const box = $('#market-intelligence');
  if (!box) return;
  
  try {
    // APIì—ì„œ ì‹œì¥ í•´ì„¤ ê°€ì ¸ì˜¤ê¸°
    const intelligence = await fetchJSON(withKey('/market_intelligence'));
    
    if (intelligence && intelligence.script) {
      box.innerHTML = intelligence.script.replace(/\n/g, '<br>');
      return;
    }
    
    // ë¡œì»¬ ë°ì´í„°ë¡œ ì „ë¬¸ê°€ê¸‰ ìë™ ë¶„ì„ ìƒì„±
    if (!regimeData) {
      box.innerHTML = 'âš ï¸ ì‹œì¥ ë°ì´í„° ë¡œë”© ì¤‘...';
      return;
    }
    
    let script = '';
    
    // 1) Regime ë¶„ì„ (ì™œ ì´ í™˜ê²½ì´ ì¤‘ìš”í•œê°€)
    script += `<b>1ï¸âƒ£ í˜„ì¬ ì‹œì¥ í™˜ê²½</b><br><br>`;
    script += `<b>${regimeData.state}</b> (${regimeData.score}/${regimeData.max_score})<br>`;
    script += `Playbook: <b>${regimeData.playbook}</b><br><br>`;
    
    if (regimeData.state === 'RISK_ON' && regimeData.score >= 2) {
      script += `âœ… <b>í†µê³„ì ìœ¼ë¡œ ê°€ì¥ ëˆ ë²Œê¸° ì‰¬ìš´ êµ¬ê°„</b><br><br>`;
      script += `ì´ìœ :<br>`;
      script += `â€¢ RISK_ON = ì£¼ì‹ ë¹„ì¤‘ ëŠ˜ë¦¬ëŠ” êµ­ë©´<br>`;
      if (regimeData.factors?.volatility) {
        script += `â€¢ ë³€ë™ì„± ì•ˆì • = íŒ¨ë‹‰ ë§¤ë„ ì—†ìŒ<br>`;
      }
      if (regimeData.factors?.breadth) {
        script += `â€¢ ì‹œì¥ í™•ì‚° = ì¼ë¶€ ì¢…ëª© ì°©ì‹œ ì•„ë‹˜<br>`;
      }
      script += `<br>ğŸ‘‰ ì´ë•ŒëŠ” <b>ì„¹í„° ë¦¬ë”</b>ê°€ ê³„ì† ëˆì„ ë¹¨ì•„ë“¤ì„<br>`;
      script += `ğŸ‘‰ ${regimeData.playbook} = ì¶”ê²© ë§¤ìˆ˜ ì•„ë‹Œ <b>ëˆŒë¦¼ ë§¤ìˆ˜</b>ê°€ ì •ë‹µ<br><br>`;
    } else if (regimeData.state === 'RISK_OFF') {
      script += `âš ï¸ <b>ë°©ì–´ êµ­ë©´ - ì§„ì… ê¸ˆì§€</b><br><br>`;
      script += `â€¢ í˜„ê¸ˆ ë¹„ì¤‘ í™•ëŒ€<br>`;
      script += `â€¢ ê¸°ì¡´ í¬ì§€ì…˜ ì†ì ˆ ê²€í† <br>`;
      script += `â€¢ Risk-On ì „í™˜ ëŒ€ê¸°<br><br>`;
    }
    
    // 2) Sector í•´ì„ (ì™œ ì´ ì„¹í„°ë“¤ì¸ê°€)
    if (sectorData && sectorData.length > 0) {
      script += `<b>2ï¸âƒ£ ìê¸ˆì˜ ë°°ì¹˜ (Capital Map)</b><br><br>`;
      
      const surge = sectorData.filter(x => x.flow_signal === 'SURGE');
      
      if (surge.length > 0) {
        script += `<b>ìê¸ˆì´ ì§‘ì¤‘ë˜ëŠ” ê³³:</b><br>`;
        surge.forEach(s => {
          script += `â€¢ ${s.sector} (${s.flow_score}ì ) - ${s.duration}<br>`;
        });
        script += `<br>`;
        
        // ì„¹í„° ì¡°í•© í•´ì„
        const sectors = surge.map(s => s.sector);
        if (sectors.includes('ë°©ì‚°') && sectors.includes('í—¬ìŠ¤ì¼€ì–´')) {
          script += `<b>ğŸ“Œ ì´ ì¡°í•©ì˜ ì˜ë¯¸:</b><br>`;
          script += `â€¢ <b>ê³µê²© ìê¸ˆ</b> â†’ ë°©ì‚° (ì§€ì •í•™ ë¦¬ìŠ¤í¬ë¥¼ ìˆ˜ìµìœ¼ë¡œ)<br>`;
          script += `â€¢ <b>ë°©ì–´ ìê¸ˆ</b> â†’ í—¬ìŠ¤ì¼€ì–´ (ê²½ê¸° ë‘”í™” ëŒ€ë¹„ í˜„ê¸ˆíë¦„)<br><br>`;
          script += `ğŸ‘‰ ê¸€ë¡œë²Œ ìì‚°ë°°ë¶„ ë¡œì§: <b>ì „ìŸÂ·ê¸ˆë¦¬ í”¼í¬Â·ê²½ê¸° ë‘”í™” ë™ì‹œ ë°˜ì˜</b><br><br>`;
        } else if (sectors.includes('ë°©ì‚°')) {
          script += `<b>ğŸ“Œ ë°©ì‚° ì§‘ì¤‘:</b> ì§€ì •í•™ì  ìœ„í—˜ì´ íˆ¬ì ê¸°íšŒë¡œ ì „í™˜ ì¤‘<br><br>`;
        } else if (sectors.includes('í—¬ìŠ¤ì¼€ì–´')) {
          script += `<b>ğŸ“Œ í—¬ìŠ¤ì¼€ì–´ ì§‘ì¤‘:</b> ë°©ì–´ì  í¬ì§€ì…”ë‹ ê°•í™”<br><br>`;
        }
      }
    }
    
    // 3) Stock Funnel í•µì‹¬ êµ¬ì¡° ë¶„ì„
    if (funnelData && selectedSector) {
      script += `<b>3ï¸âƒ£ ${selectedSector} ì„¹í„° êµ¬ì¡°</b><br><br>`;
      
      const leaders = funnelData.leader || [];
      const followers = funnelData.follower || [];
      
      script += `Leader: ${leaders.length > 0 ? leaders.map(x => x.name || x.ticker).join(', ') : '<b>ì—†ìŒ</b>'}<br>`;
      script += `Follower: ${followers.length > 0 ? followers.map(x => x.name || x.ticker).join(', ') : '<b>ì—†ìŒ</b>'}<br><br>`;
      
      // êµ¬ì¡°ë³„ ì •ë°€ í•´ì„
      if (leaders.length === 0 && followers.length > 0) {
        script += `<b>ğŸ¯ ë§¤ìš° ì¤‘ìš”í•œ êµ¬ì¡° (ìµœê³  ìˆ˜ìµë¥  ë‹¨ê³„)</b><br><br>`;
        script += `<b>ì„¹í„°ëŠ” ë‹¬ë¦¬ëŠ”ë°, ì¢…ëª©ì€ ì•„ì§ ì•ˆ í„°ì§</b><br><br>`;
        script += `ì¼ë°˜ì  ìˆœì„œ:<br>`;
        script += `1) ì„¹í„° ìê¸ˆ ìœ ì… âœ…<br>`;
        script += `2) <b>Follower ê¸‰ë“± â† ì§€ê¸ˆ ì—¬ê¸°</b><br>`;
        script += `3) Leader í™•ì •<br>`;
        script += `4) ê°œì¸ ëª°ë¦¼ â†’ ë<br><br>`;
        script += `ğŸ‘‰ ${followers.map(x => x.name || x.ticker).join(', ')}ê°€ Follower = <b>ë‹¤ìŒ ë¦¬ë” í›„ë³´</b><br>`;
        script += `ğŸ‘‰ ì „ëµ: <b>ëŒíŒŒ ì¶”ê²© ì•„ë‹Œ, ëˆŒë¦¼ì—ì„œ ì¡°ìš©íˆ ë§¤ì§‘</b><br><br>`;
      } else if (leaders.length > 0 && followers.length === 0) {
        const leaderName = leaders[0].name || leaders[0].ticker;
        script += `<b>ğŸ“Œ ìê¸ˆ ì§‘ì¤‘ êµ¬ì¡°</b><br><br>`;
        script += `â€¢ ${leaderName}ì—ë§Œ ìê¸ˆ ì§‘ì¤‘<br>`;
        script += `â€¢ ì„¹í„° í™•ì‚° ì•„ì§ ì•ˆ ë¨<br><br>`;
        
        if (selectedSector === 'í—¬ìŠ¤ì¼€ì–´' || leaderName.includes('JNJ')) {
          script += `<b>JNJì˜ ì˜ë¯¸:</b><br>`;
          script += `â€¢ í˜„ê¸ˆíë¦„ + ë°°ë‹¹ + ê¸€ë¡œë²Œ ë°©ì–´ ìì‚°<br>`;
          script += `â€¢ ê¸°ê´€ì˜ "ì•ˆì „í•œ í”¼ë‚œì²˜" í¬ì§€ì…˜<br><br>`;
          script += `ğŸ‘‰ íŠ¸ë ˆì´ë”© ì•„ë‹Œ <b>í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆì •í™”</b><br>`;
          script += `ğŸ‘‰ ì „ëµ: ëˆŒë¦¼ë³´ë‹¤ <b>ì¶”ì„¸ ì¶”ì¢…</b>ì´ ë§ìŒ<br><br>`;
        } else {
          script += `ğŸ‘‰ ì „ëµ: <b>ì•ˆì •í˜•Â·ë°©ì–´í˜• íŠ¸ë ˆì´ë“œ ìµœì </b><br><br>`;
        }
      } else if (leaders.length > 0 && followers.length > 0) {
        script += `<b>ğŸ“Œ ì„¹í„° ì „ì²´ ìƒìŠ¹ êµ­ë©´</b><br><br>`;
        script += `â€¢ ì„ ë„ì£¼ê°€ ì´ëŒê³  ì¶”ì¢…ì£¼ê°€ ë”°ë¼ì˜´<br>`;
        script += `â€¢ Leader: ì¶”ê²© ì£¼ì˜ (ì´ë¯¸ ë§ì´ ì˜¤ë¦„)<br>`;
        script += `â€¢ Follower: <b>ëˆŒë¦¼ ë§¤ìˆ˜ íƒ€ì´ë°</b><br><br>`;
      }
    }
    
    // 4) ì‹¤ì „ ì „ëµ (íˆ¬ì ì„±í–¥ë³„)
    script += `<b>4ï¸âƒ£ ì‹¤ì „ ì „ëµ (ì„±í–¥ë³„)</b><br><br>`;
    
    if (regimeData.state === 'RISK_ON' && sectorData) {
      const surge = sectorData.filter(x => x.flow_signal === 'SURGE');
      
      if (surge.length > 0 && funnelData && selectedSector) {
        const followers = funnelData.follower || [];
        const leaders = funnelData.leader || [];
        
        if (followers.length > 0) {
          script += `<b>ê³µê²©ì :</b> ${selectedSector} â†’ `;
          script += `${followers.slice(0, 2).map(x => x.name || x.ticker).join(', ')} <b>ëˆŒë¦¼ ë§¤ìˆ˜ ëŒ€ê¸°</b><br>`;
        }
        
        if (leaders.length > 0) {
          const leaderName = leaders[0].name || leaders[0].ticker;
          if (selectedSector === 'í—¬ìŠ¤ì¼€ì–´' || leaderName.includes('JNJ')) {
            script += `<b>ì•ˆì •ì :</b> ${leaderName} <b>ì¶”ì„¸ ì¶”ì¢…</b> (íƒ€ì´ë°ë³´ë‹¤ ë³´ìœ )<br>`;
          } else {
            script += `<b>ì•ˆì •ì :</b> ${leaderName} ì¶”ì„¸ ì¶”ì¢…<br>`;
          }
        }
        
        script += `<b>í˜„ê¸ˆ ë§ìŒ:</b> ê°ì‹œë§Œ, <b>ì¶”ê²© ê¸ˆì§€</b><br><br>`;
      }
      
      script += `<b>ğŸ¯ í•µì‹¬:</b><br>`;
      script += `ì•„ë¬´ê±°ë‚˜ ì‚¬ëŠ” ì¥ì´ ì•„ë‹ˆë¼<br>`;
      script += `<b>"ìê¸ˆì´ ëª°ë¦¬ëŠ” ì„¹í„° ì•ˆì—ì„œ, ëˆŒë¦¼ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¥"</b><br><br>`;
      
      // ì‹œì¥ êµ¬ì¡° í•œ ë¬¸ì¥ ìš”ì•½
      if (surge.length >= 2) {
        const sectors = surge.map(s => s.sector);
        if (sectors.includes('ë°©ì‚°') && sectors.includes('í—¬ìŠ¤ì¼€ì–´')) {
          script += `<b>ğŸ“Š í˜„ì¬ ì‹œì¥ êµ¬ì¡°:</b><br>`;
          script += `<b>"ê³µê²© ìê¸ˆì€ ë°©ì‚°ìœ¼ë¡œ, ë°©ì–´ ìê¸ˆì€ í—¬ìŠ¤ì¼€ì–´ë¡œ ì´ë™ ì¤‘ì¸ Risk-On ì¥"</b>`;
        }
      }
    } else {
      script += `<b>í˜„ì¬ ì „ëµ:</b> ê´€ë§ / í˜„ê¸ˆ ëŒ€ê¸°<br>`;
      script += `Risk-Off êµ¬ê°„ = ì§„ì… ê¸ˆì§€`;
    }
    
    box.innerHTML = script;
    
  } catch (error) {
    console.error('Market Intelligence Error:', error);
    box.innerHTML = 'âŒ ë¶„ì„ ìƒì„± ì‹¤íŒ¨';
  }
}

// ========== Init ==========
async function init() {
  console.log('ğŸš€ Initializing Decision Stream...');
  
  try {
    // Set user plan
    $('#user-plan').textContent = USER_PLAN;
    $('#user-plan').className = 'pill plan-free';
    
    // Trade Plan cardëŠ” í•­ìƒ í‘œì‹œ (FREEë„ ì‚¬ìš© ê°€ëŠ¥)
    
    // Load data
    console.log('ğŸ“Š Loading Market Regime...');
    await loadRegime();
    
    console.log('ğŸŒ¡ï¸ Loading Sector Heatmap...');
    await loadSectors();
    
    console.log('âœ… All Data Loaded Successfully!');
  } catch (error) {
    console.error('âŒ Initialization Error:', error);
    
    // ì—ëŸ¬ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
    const regimeBadge = $('#regime-badge');
    if (regimeBadge) {
      regimeBadge.textContent = 'ì˜¤ë¥˜';
      regimeBadge.className = 'badge err';
    }
    
    const sectorList = $('#sector-list');
    if (sectorList) {
      sectorList.innerHTML = `
        <div class="alert danger" style="margin: 16px 0;">
          <strong>âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</strong><br>
          <small>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.</small><br>
          <button onclick="location.reload()" style="margin-top:8px; padding:6px 12px; background:#f56565; color:white; border:none; border-radius:4px; cursor:pointer;">
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      `;
    }
  }
}

// Run on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
