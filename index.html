<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Decision Stream - ì¤‘ê¸° ìŠ¤ìœ™ íˆ¬ì ì‹œìŠ¤í…œ</title>

<style>
:root{
  --bg:#0b1020; --panel:#12183a; --card:#151c45;
  --line:#24306a; --text:#e7ebff; --muted:#aab3d6;
  --ok:#52d27d; --warn:#ffb84d; --err:#ff4d4d; --accent:#4a90e2;
  --radius:14px;
}

* { box-sizing: border-box; }

body {
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
}

header {
  padding:16px 24px; border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
}

header h1 {
  font-size:20px; margin:0; font-weight:900;
}

.header-right {
  display:flex; gap:12px; align-items:center;
}

.pill {
  padding:6px 12px; border-radius:999px;
  background:#0f1730; color:var(--muted);
  font-size:12px; font-weight:600;
}

.pill.plan-free { background:#1a3a1a; color:#52d27d; }
.pill.plan-pro { background:#3a2a1a; color:#ffb84d; }
.pill.plan-elite { background:#3a1a2a; color:#ff4d4d; }

.container {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap:16px;
  padding:16px;
  max-width:1800px;
  margin:0 auto;
}

.card {
  background:linear-gradient(180deg, #141b45 0%, var(--card) 100%);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:16px;
  min-height:220px;
}

.card h3 {
  margin:0 0 12px 0;
  font-size:15px;
  color:#cdd6ff;
}

.small {
  font-size:12px;
  color:var(--muted);
}

.row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}

.badge {
  padding:4px 10px;
  border-radius:8px;
  font-size:11px;
  font-weight:700;
}

.badge.ok { background:#153f2a; color:var(--ok); }
.badge.warn { background:#3f2e15; color:var(--warn); }
.badge.err { background:#3f1515; color:var(--err); }

.list {
  display:flex;
  flex-direction:column;
  gap:8px;
}

.item {
  padding:10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#10174a;
  cursor:pointer;
  transition: all 0.2s;
}

.item:hover {
  border-color:#3a49a5;
  background:#1a2460;
}

.item.disabled {
  opacity:.4;
  cursor:not-allowed;
}

.item.disabled:hover {
  border-color:var(--line);
  background:#10174a;
}

.kv {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin:6px 0;
}

.sep {
  height:1px;
  background:var(--line);
  margin:12px 0;
}

button {
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #2e3a7a;
  background:#1a2460;
  color:#fff;
  cursor:pointer;
  font-weight:700;
  font-size:13px;
  width:100%;
  transition: all 0.2s;
}

button:hover {
  background:#2a3470;
}

button:disabled {
  opacity:.5;
  cursor:not-allowed;
}

button.secondary {
  background:#12183a;
  border-color:#1e2550;
}

button.danger {
  background:#5a1d2a;
  border-color:#7a2e3a;
}

.state-badge {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 15px;
}

.state-buy-now { background: rgba(74,144,226,0.2); color: #4A90E2; border: 2px solid #4A90E2; }
.state-buy-pullback { background: rgba(82,210,125,0.2); color: #52D27D; border: 2px solid #52D27D; }
.state-accumulate { background: rgba(255,184,77,0.2); color: #FFB84D; border: 2px solid #FFB84D; }
.state-watch { background: rgba(170,179,214,0.2); color: #AAB3D6; border: 2px solid #AAB3D6; }
.state-hold-off { background: rgba(255,154,102,0.2); color: #FF9A66; border: 2px solid #FF9A66; }
.state-no-go { background: rgba(255,77,77,0.2); color: #FF4D4D; border: 2px solid #FF4D4D; }

.checklist-grid {
  display: grid;
  gap: 8px;
  margin: 12px 0;
}

.check-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  border-left: 3px solid transparent;
}

.check-item.pass {
  border-left-color: #52D27D;
}

.check-item.fail {
  border-left-color: #FF4D4D;
}

.check-icon {
  font-size: 18px;
}

.check-text {
  flex: 1;
  font-size: 13px;
  color: #cdd6ff;
}

input, select {
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #2e3a7a;
  background:#0f1730;
  color:#fff;
  font-size:13px;
}

.plan-input {
  cursor: pointer;
}

.plan-section {
  background: rgba(255,255,255,0.03);
  border-left: 3px solid var(--primary);
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
}

.plan-section h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--primary);
}

.plan-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.plan-row:last-child {
  border-bottom: none;
}

.plan-label {
  color: var(--muted);
  font-size: 13px;
}

.plan-value {
  font-weight: 600;
  font-size: 14px;
}

.plan-value.bullish {
  color: #4ade80;
}

.plan-value.bearish {
  color: #ff4d4d;
}

.footer {
  padding:16px 24px;
  border-top:1px solid var(--line);
  text-align:center;
  color:var(--muted);
  font-size:12px;
}

/* Why Drawer Styles */
.drawer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
}

.drawer-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
}

.drawer-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 600px;
  max-height: 85vh;
  background: linear-gradient(135deg, #1a1f36 0%, #232842 100%);
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  overflow: hidden;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translate(-50%, -40%);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

.drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.drawer-header h3 {
  margin: 0;
  font-size: 18px;
  color: #fff;
}

.close-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.drawer-body {
  padding: 24px;
  max-height: calc(85vh - 80px);
  overflow-y: auto;
}

.drawer-body::-webkit-scrollbar {
  width: 8px;
}

.drawer-body::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.drawer-body::-webkit-scrollbar-thumb {
  background: rgba(102, 126, 234, 0.5);
  border-radius: 4px;
}

.drawer-body::-webkit-scrollbar-thumb:hover {
  background: rgba(102, 126, 234, 0.7);
}

.score-summary {
  text-align: center;
  padding: 20px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 12px;
  margin-bottom: 24px;
}

.score-big {
  font-size: 48px;
  font-weight: 700;
  color: #667eea;
  margin-bottom: 8px;
}

.score-label {
  font-size: 14px;
  color: #aab3d6;
}

.section {
  margin-bottom: 24px;
}

.section h4 {
  font-size: 15px;
  color: #fff;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.section.devil h4 {
  color: #ef4444;
}

.reason-item {
  padding: 12px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  margin-bottom: 8px;
  line-height: 1.6;
}

.reason-item.counter {
  background: rgba(239, 68, 68, 0.1);
  border-left: 3px solid #ef4444;
}

.reason-text {
  font-size: 13px;
  color: #e8eaed;
  margin-bottom: 4px;
}

.reason-source {
  font-size: 11px;
  color: #aab3d6;
}

.reason-source a {
  color: #667eea;
  text-decoration: none;
}

.reason-source a:hover {
  text-decoration: underline;
}

.confidence {
  text-align: center;
  padding: 16px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  font-size: 14px;
  color: #aab3d6;
}

.confidence span:last-child {
  font-weight: 700;
  color: #667eea;
  margin-left: 8px;
  font-size: 16px;
}

.hidden {
  display:none;
}

.loading {
  text-align:center;
  padding:20px;
  color:var(--muted);
}

@media (max-width: 1200px) {
  .container {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
}

@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr;
  }
  
  header {
    flex-direction:column;
    gap:12px;
  }
}
</style>
</head>

<body>

<header>
  <h1>ğŸ“Š Decision Stream v4.0</h1>
  <div class="header-right">
    <button onclick="window.open('youtube_script_generator.html', '_blank')" 
            style="padding:8px 16px; background:#5a2a3a; color:#ff9a9e; border:1px solid #8a4a5a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ¬ ìœ íŠœë¸Œ ëŒ€ë³¸
    </button>
    <button onclick="window.open('algorithm_structure.html', '_blank')" 
            style="padding:8px 16px; background:#2a3a4a; color:#90cdf4; border:1px solid #4a6a7a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ§® ì•Œê³ ë¦¬ì¦˜
    </button>
    <button onclick="window.open('news_filter.html', '_blank')" 
            style="padding:8px 16px; background:#3a4a2a; color:#90ee90; border:1px solid #5a7a4a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ“° ë‰´ìŠ¤ í•„í„°
    </button>
    <button onclick="window.open('user_guide.html', '_blank')" 
            style="padding:8px 16px; background:#2a3a5a; color:#90cdf4; border:1px solid #4a6a9a; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
      ğŸ“š ì‚¬ìš© ê°€ì´ë“œ
    </button>
    <span class="pill">KR Â· US</span>
    <span class="pill">ì¤‘ê¸° ìŠ¤ìœ™</span>
  </div>
</header>

<div class="container">

  <!-- 1. Market Regime -->
  <div class="card">
    <h3>1) Market Regime</h3>
    <div class="row">
      <div class="small">ì‹œì¥ ìƒíƒœ</div>
      <span id="regime-badge" class="badge warn">ë¡œë”©ì¤‘</span>
    </div>
    <div class="sep"></div>
    <div class="kv"><span>Risk Score</span><b id="risk-score">-</b></div>
    <div class="kv"><span>Playbook</span><b id="playbook">-</b></div>
    <div class="sep"></div>
    <div class="small" style="color:var(--muted); font-size:11px; line-height:1.6; padding:8px; background:rgba(102,126,234,0.1); border-radius:6px; border-left:3px solid #667eea;">
      ğŸ’¡ <b>Risk-On</b> = ì‚¬ë„ ì£½ì§€ ì•Šì„ í™•ë¥ ì´ ë†’ë‹¤ (ë§¤ìˆ˜ ì‹ í˜¸ ì•„ë‹˜)<br>
      ğŸ’¡ <b>Risk-Off</b> = ì§„ì… ê¸ˆì§€ (ê¸°ì¡´ í¬ì§€ì…˜ ì†ì ˆ ê²€í† )
    </div>
    <div class="sep"></div>
    <div id="regime-desc" class="small"></div>
    <div class="sep"></div>
    <div id="market-intelligence" class="small" style="line-height:1.8; padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;">
      <div class="loading">ì‹œì¥ ë¶„ì„ ë¡œë”©ì¤‘...</div>
    </div>
  </div>

  <!-- 2. Sector Heatmap -->
  <div class="card">
    <h3>2) Sector Heatmap</h3>
    <div class="small">SURGE ì„¹í„°ë§Œ í´ë¦­ ê°€ëŠ¥</div>
    <div class="sep"></div>
    <div class="list" id="sector-list">
      <div class="loading">ë°ì´í„° ë¡œë”©ì¤‘...</div>
    </div>
    <div class="sep"></div>
    <div id="sector-desc" class="small"></div>
  </div>

  <!-- 3. Stock Funnel -->
  <div class="card">
    <h3>3) Stock Funnel</h3>
    <div id="funnel-status" class="small">ì„¹í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="sep"></div>
    
    <div class="small" style="font-weight:700;">Leader (ì„ ë„ì£¼)</div>
    <div class="list" id="leader">
      <div class="small">-</div>
    </div>
    
    <div class="sep"></div>
    
    <div class="small" style="font-weight:700;">Follower (ì¶”ì¢…ì£¼)</div>
    <div class="list" id="follower">
      <div class="small">-</div>
    </div>
    
    <div class="sep"></div>
    
    <div class="small" style="font-weight:700; color:#ff4d4d;">
      No-Go (íšŒí”¼) 
      <span style="font-size:11px; color:var(--muted); font-weight:400;">ğŸ’¡ ì‹œìŠ¤í…œ ì‹ ë¢°ë„ ê²€ì¦ìš©</span>
    </div>
    <div class="list" id="nogo">
      <div class="small">-</div>
    </div>
    
    <div class="sep"></div>
    <div id="funnel-desc" class="small"></div>
  </div>

  <!-- 4. Watch & Checklist -->
  <div class="card">
    <h3>4) Watch & Checklist</h3>
    <div class="small" style="color:var(--muted); font-size:11px; line-height:1.6; padding:8px; background:rgba(255,77,77,0.1); border-radius:6px; border-left:3px solid #ff4d4d; margin-bottom:12px;">
      âš ï¸ "ì§€ê¸ˆ ì‚¬ë„ ë˜ëŠ”ê°€" ì•„ë‹Œ <b>"ì‚¬ë©´ ì•ˆ ë˜ëŠ” ì´ìœ ê°€ ìˆëŠ”ê°€"</b>ë¥¼ ì²´í¬
    </div>
    <div id="checklist-status" class="small">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="sep"></div>
    <div id="checklist-result"></div>
    
    <!-- Devil's Advocate (ë°˜ëŒ€ ì˜ê²¬) -->
    <div id="devils-advocate" style="display:none; margin-top:16px;">
      <div class="sep"></div>
      <div style="padding:12px; background:rgba(239,68,68,0.1); border-radius:8px; border-left:3px solid #ef4444;">
        <div style="font-weight:700; font-size:13px; color:#ef4444; margin-bottom:8px;">ğŸ˜ˆ Devil's Advocate (ë°˜ëŒ€ ì˜ê²¬)</div>
        <div id="counter-arguments" class="small" style="line-height:1.7;"></div>
      </div>
    </div>
  </div>

  <!-- 5. Trade Plan Builder -->
  <div class="card" id="trade-plan-card" style="display:none;">
    <h3>5) ë§¤ë§¤ ê³„íš (Trade Plan)</h3>
    <div class="small" style="color:var(--muted); font-size:11px; line-height:1.6; padding:8px; background:rgba(102,126,234,0.1); border-radius:6px; border-left:3px solid #667eea; margin-bottom:12px;">
      ğŸ’¡ <b>ì†ì ˆ ë¨¼ì € ê³ ì •</b> â†’ ì§„ì…/ëª©í‘œ ê³„ì‚° (ë¦¬ìŠ¤í¬ ê´€ë¦¬ ìµœìš°ì„ )
    </div>
    
    <!-- ì‚¬ìš©ì ì…ë ¥ (ìµœì†Œí™” - 2ê°œë§Œ) -->
    <div style="display:flex; gap:12px; margin-bottom:16px;">
      <div style="flex:1;">
        <div class="small" style="margin-bottom:4px; color:var(--muted);">íˆ¬ìê¸°ê°„</div>
        <select id="plan-period" class="plan-input" onchange="updateTradePlan()">
          <option value="ë‹¨ê¸°">ë‹¨ê¸° (ìˆ˜ì¼~2ì£¼)</option>
          <option value="ì¤‘ê¸°" selected>ì¤‘ê¸° (1~3ê°œì›”)</option>
        </select>
      </div>
      <div style="flex:1;">
        <div class="small" style="margin-bottom:4px; color:var(--muted);">ë¦¬ìŠ¤í¬ ì„±í–¥</div>
        <select id="plan-risk" class="plan-input" onchange="updateTradePlan()">
          <option value="ë³´ìˆ˜">ë³´ìˆ˜ì </option>
          <option value="ì¤‘ë¦½" selected>ì¤‘ë¦½</option>
          <option value="ê³µê²©">ê³µê²©ì </option>
        </select>
      </div>
    </div>
    
    <div class="sep"></div>
    
    <!-- ê³„íš ê²°ê³¼ -->
    <div id="plan-result"></div>
    
    <div class="sep"></div>
    
    <!-- ìƒì„¸ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ -->
    <button onclick="openDetailedSimulation()" 
            style="width:100%; padding:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px;">
      ğŸ“Š ìƒì„¸ ì‹œë®¬ë ˆì´ì…˜ ì—´ê¸°
      <span style="font-size:11px; opacity:0.8;">(trade_plan_simulation.html)</span>
    </button>
  </div>

</div>

<!-- Why Drawer Modal -->
<div id="why-drawer" class="drawer" style="display:none;">
  <div class="drawer-overlay" onclick="closeWhyDrawer()"></div>
  <div class="drawer-content">
    <div class="drawer-header">
      <h3 id="drawer-title">ğŸ” Why Score: ?</h3>
      <button onclick="closeWhyDrawer()" class="close-btn">âœ•</button>
    </div>
    
    <div class="drawer-body">
      <!-- ì ìˆ˜ ìš”ì•½ -->
      <div class="score-summary">
        <div class="score-big" id="drawer-score">-</div>
        <div class="score-label" id="drawer-label">-</div>
      </div>
      
      <!-- ì§€ì§€ ê·¼ê±° -->
      <div class="section">
        <h4>âœ… ì´ ì ìˆ˜ë¥¼ ì§€ì§€í•˜ëŠ” ê·¼ê±°</h4>
        <div id="supporting-reasons"></div>
      </div>
      
      <!-- ë°˜ëŒ€ ì˜ê²¬ -->
      <div class="section devil">
        <h4>ğŸ˜ˆ Devil's Advocate (ë°˜ëŒ€ ì˜ê²¬)</h4>
        <div id="counter-reasons"></div>
      </div>
      
      <!-- ì‹ ë¢°ë„ -->
      <div class="confidence">
        <span>ğŸ¯ ì‹ ë¢°ë„:</span>
        <span id="confidence-level">-</span>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  <p>íˆ¬ì íŒë‹¨ ë³´ì¡° ë„êµ¬ì…ë‹ˆë‹¤. ë§¤ìˆ˜Â·ë§¤ë„ ê¶Œìœ  ë° ìˆ˜ìµ ë³´ì¥ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
  <p>Â© 2026 Decision Stream - ì¤‘ê¸° ìŠ¤ìœ™ íˆ¬ì í”„ë ˆì„ì›Œí¬</p>
</div>

<script>
// ========== Configuration ==========
const USER_PLAN = "Î² v1.0"; // FREE | PRO | ELITE

// í™˜ê²½ ìë™ ê°ì§€
const isDevelopment = window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1' ||
                     window.location.protocol === 'file:' ||
                     window.location.hostname === '';

// ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© - CORS ë¬¸ì œ í•´ê²°
const API = ''; // ìƒëŒ€ ê²½ë¡œë§Œ ì‚¬ìš©

const ACCESS_KEY = "ds-test-2026";
const USE_MOCK_DATA = true; // â¬…ï¸ Mock ë°ì´í„° ì‚¬ìš© (ë°±ì—”ë“œ ì—†ì„ ë•Œ)

// ========== State ==========
let selectedSector = null;
let selectedStock = null;
let lastPlan = null;
let regimeData = null;
let sectorData = null;
let funnelData = null;

// ========== Helpers ==========
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const withKey = p => `${p}${p.includes('?')?'&':'?'}key=${ACCESS_KEY}`;  // ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©

// í†µí™”ë³„ ê°€ê²© í‘œì‹œ í•¨ìˆ˜
const formatPrice = (price, currency) => {
  if (!price && price !== 0) return 'N/A';
  
  // currencyê°€ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •ë˜ì§€ ì•Šì€ ê²½ìš° tickerë¡œ íŒë‹¨
  if (!currency) {
    currency = 'KRW'; // ê¸°ë³¸ê°’
  }
  
  const numPrice = typeof price === 'string' ? parseFloat(price) : price;
  
  if (currency === 'USD') {
    return `$${numPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
  } else {
    return `${Math.round(numPrice).toLocaleString('ko-KR')}ì›`;
  }
};

// tickerë¡œ í†µí™” ìë™ ê°ì§€
const detectCurrency = (ticker) => {
  if (!ticker) return 'KRW';
  // ìˆ«ìë¡œ ì‹œì‘í•˜ë©´ í•œêµ­ ì£¼ì‹ (KRW), ì•ŒíŒŒë²³ì´ë©´ ë¯¸êµ­ ì£¼ì‹ (USD)
  return /^[0-9]/.test(ticker) ? 'KRW' : 'USD';
};

// Mock ë°ì´í„°
const MOCK_DATA = {
  regime: {
    state: 'RISK_ON',
    score: 2,
    max_score: 3,
    playbook: 'ëˆŒë¦¼ ë§¤ìˆ˜ í—ˆê°€',
    factors: {
      breadth: true,     // ìƒìŠ¹:í•˜ë½ 1.3:1
      volatility: true,  // VKOSPI 18
      theme: false       // ì§€ì† í…Œë§ˆ 1ê°œ ë¯¸ë§Œ
    },
    note: 'Risk_ON = ì‚¬ë„ ì£½ì§€ ì•Šì„ í™•ë¥ ì´ ë†’ë‹¤',
    detail: {
      breadth_ratio: '1.3:1 (ìƒìŠ¹ 650, í•˜ë½ 500)',
      vkospi: 18,
      lasting_themes: ['ë°©ì‚°']
    }
  },
  sectors: [
    { sector: 'ë°©ì‚°', flow_score: 97, flow_signal: 'SURGE', duration: '2ì£¼ ì§€ì†' },
    { sector: 'í—¬ìŠ¤ì¼€ì–´', flow_score: 96, flow_signal: 'SURGE', duration: '1ì£¼ ì§€ì†' },
    { sector: 'AI ë°˜ë„ì²´', flow_score: 46, flow_signal: 'NORMAL', duration: '-' },
    { sector: 'ì „ë ¥', flow_score: 45, flow_signal: 'NORMAL', duration: '-' },
    { sector: 'ì—ë„ˆì§€', flow_score: 8, flow_signal: 'NORMAL', duration: '-' }
  ],
  funnels: {
    'ë°©ì‚°': {
      leader: [
        { ticker: 'LMT', name: 'Lockheed Martin', price: 649.00, currency: 'USD' }
      ],
      follower: [
        { ticker: '012450', name: 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', price: 1149000, currency: 'KRW' },
        { ticker: '079550', name: 'LIGë„¥ìŠ¤ì›', price: 544000, currency: 'KRW' }
      ],
      nogo: [
        { 
          ticker: 'RTX', 
          name: 'Raytheon Technologies', 
          price: 98.50,
          currency: 'USD',
          reason: 'ê³¼ì—´ (3ì¼ +22%, ê±°ë˜ëŒ€ê¸ˆ í­ë°œ)',
          detail: 'ë‹¨ì¼ ê¸°ì‚¬ ê¸‰ë“±, ê°œì¸ë§Œ ë§¤ìˆ˜'
        }
      ]
    },
    'í—¬ìŠ¤ì¼€ì–´': {
      leader: [
        { ticker: 'JNJ', name: 'Johnson & Johnson', price: 215.00, currency: 'USD' }
      ],
      follower: [
        { ticker: '207940', name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', price: 1720000, currency: 'KRW' },
        { ticker: '068270', name: 'ì…€íŠ¸ë¦¬ì˜¨', price: 175000, currency: 'KRW' }
      ],
      nogo: [
        {
          ticker: '086900',
          name: 'ë©”ë””í†¡ìŠ¤',
          price: 45000,
          currency: 'KRW',
          reason: 'í…Œë§ˆ ë§ê¸° (5ë²ˆì§¸ ê¸‰ë“±ì£¼)',
          detail: 'ìœ ë™ì„± ë¶€ì¡±, ì»¤ë®¤ë‹ˆí‹° ê³¼ì—´'
        }
      ]
    },
    'AI ë°˜ë„ì²´': {
      leader: [
        { ticker: 'NVDA', name: 'NVIDIA', price: 875.00, currency: 'USD' }
      ],
      follower: [
        { ticker: '005930', name: 'ì‚¼ì„±ì „ì', price: 75000, currency: 'KRW' },
        { ticker: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', price: 142000, currency: 'KRW' }
      ],
      nogo: [
        {
          ticker: 'XYZ123',
          name: 'AIí…Œë§ˆì£¼',
          price: 12000,
          currency: 'KRW',
          reason: 'ë£¨ë¨¸ì„± ì¬ë£Œ (ê²€ì¦ ì•ˆë¨)',
          detail: 'í˜¼ì ê¸‰ë“±, ê¸°ê´€/ì™¸êµ­ì¸ ë§¤ë„'
        }
      ]
    }
  },
  market_intelligence: {
    script: `í˜„ì¬ ì‹œì¥ì€ RISK_ON êµ­ë©´ì´ë©°, ìê¸ˆì´ ë°©ì‚°ê³¼ í—¬ìŠ¤ì¼€ì–´ ì„¹í„°ë¡œ ì§‘ì¤‘ë˜ê³  ìˆìŠµë‹ˆë‹¤.\n\në°©ì‚° ì„¹í„°ëŠ” 2ì£¼ì§¸ SURGE ì‹ í˜¸ë¥¼ ìœ ì§€í•˜ê³  ìˆìœ¼ë©°, Lockheed Martinê³¼ í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤ê°€ Followerë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.\n\nì „ëµ: ëˆŒë¦¼ ë§¤ìˆ˜ ëŒ€ê¸°. 20ì¼ì„  ì§€ì§€ í™•ì¸ í›„ ì§„ì…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
  }
};

const fetchJSON = async (url) => {
  // Mock ë°ì´í„° ì‚¬ìš©
  if (USE_MOCK_DATA) {
    console.log('ğŸ”µ Using Mock Data:', url);
    
    // ì¦‰ì‹œ ë°˜í™˜ (ë”œë ˆì´ ì œê±°)
    if (url.includes('/regime')) {
      console.log('âœ… Returning regime data');
      return MOCK_DATA.regime;
    }
    if (url.includes('/sectors')) {
      console.log('âœ… Returning sectors data');
      return MOCK_DATA.sectors;
    }
    if (url.includes('/funnel')) {
      const sector = url.match(/sector=([^&]+)/)?.[1];
      const decodedSector = decodeURIComponent(sector || '');
      console.log('âœ… Returning funnel data for:', decodedSector);
      return MOCK_DATA.funnels[decodedSector] || null;
    }
    if (url.includes('/market_intelligence')) {
      console.log('âœ… Returning market intelligence');
      return MOCK_DATA.market_intelligence;
    }
    if (url.includes('/checklist')) {
      return {
        'ê°€ê²© êµ¬ì¡°': true,
        'ìˆ˜ê¸‰ ì‹ í˜¸': true,
        'ë³€ë™ì„±': false,
        'ë¦¬ìŠ¤í¬': true
      };
    }
    if (url.includes('/nogo_report')) {
      return {
        reasons: ['ê³¼ì—´ ì‹ í˜¸ ê°ì§€', 'ê±°ë˜ëŸ‰ ê¸‰ì¦'],
        conclusion: 'ì§„ì… ê¸ˆì§€'
      };
    }
    if (url.includes('/plan')) {
      return {
        entry: { breakout: '100,000', pullback: '98,000' },
        stop_loss: '95,000',
        targets: ['105,000', '110,000'],
        position_size: '20%'
      };
    }
    
    console.warn('âš ï¸ No mock data for:', url);
    return null;
  }
  
  // ì‹¤ì œ API í˜¸ì¶œ
  try {
    console.log('ğŸŒ Fetching from API:', url);
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    console.log('âœ… API response:', data);
    return data;
  } catch (error) {
    console.error('âŒ API Error:', error);
    // API ì‹¤íŒ¨ ì‹œ mock ë°ì´í„°ë¡œ í´ë°±í•˜ì§€ ì•ŠìŒ
    return null;
  }
};

// ========== ìë™ ê°€ê²© ì—…ë°ì´íŠ¸ ==========
async function updateStockPrices() {
  console.log('ğŸ’° Updating stock prices from API...');
  
  // ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
  const allTickers = [];
  
  // ëª¨ë“  í‹°ì»¤ ìˆ˜ì§‘
  for (const sector in MOCK_DATA.funnels) {
    const funnel = MOCK_DATA.funnels[sector];
    ['leader', 'follower', 'nogo'].forEach(category => {
      if (funnel[category]) {
        funnel[category].forEach(stock => {
          allTickers.push({ sector, category, ticker: stock.ticker });
        });
      }
    });
  }
  
  // ê° í‹°ì»¤ì˜ ìµœì‹  ê°€ê²© ê°€ì ¸ì˜¤ê¸°
  let updated = 0;
  for (const item of allTickers) {
    try {
      const response = await fetch(`/api/chart/${item.ticker}?key=${ACCESS_KEY}`);
      if (response.ok) {
        const data = await response.json();
        const latestPrice = data.indicators.current_price;
        
        // Mock ë°ì´í„° ì—…ë°ì´íŠ¸
        const stocks = MOCK_DATA.funnels[item.sector][item.category];
        const stock = stocks.find(s => s.ticker === item.ticker);
        if (stock && latestPrice) {
          stock.price = latestPrice;
          updated++;
          console.log(`  âœ… ${item.ticker}: ${latestPrice}`);
        }
      }
    } catch (error) {
      console.warn(`  âš ï¸ ${item.ticker}: Failed to fetch (using cached price)`);
    }
  }
  
  console.log(`ğŸ’° Updated ${updated}/${allTickers.length} stock prices`);
}

// ========== 1. Market Regime ==========
async function loadRegime() {
  regimeData = await fetchJSON(withKey('/regime'));
  if (!regimeData) return;
  
  $('#playbook').innerText = regimeData.playbook || '-';
  
  // Risk Score í‘œì‹œ (3ì  ë§Œì )
  const scoreText = `${regimeData.score || 0} / ${regimeData.max_score || 3}`;
  $('#risk-score').innerText = scoreText;
  
  const badge = $('#regime-badge');
  badge.textContent = regimeData.state || 'UNKNOWN';
  badge.className = 'badge ' + (regimeData.state === 'RISK_ON' ? 'ok' : 'err');
  
  // 3ê°€ì§€ ê¸°ì¤€ í‘œì‹œ
  const factors = regimeData.factors || {};
  const factorText = `
    âœ“ Breadth (ì‹œì¥ í™•ì‚°): ${factors.breadth ? 'âœ…' : 'âŒ'}<br>
    âœ“ Volatility (ë³€ë™ì„± ì–µì œ): ${factors.volatility ? 'âœ…' : 'âŒ'}<br>
    âœ“ Theme (í…Œë§ˆ ì§€ì†): ${factors.theme ? 'âœ…' : 'âŒ'}
  `;
  
  $('#regime-desc').innerHTML = factorText;
  
  // ì‹œì¥ í•´ì„¤ ìë™ ìƒì„±
  generateMarketIntelligence();
}

// ========== 2. Sectors ==========
async function loadSectors() {
  const list = $('#sector-list');
  list.innerHTML = '';
  
  sectorData = await fetchJSON(withKey('/sectors'));
  if (!sectorData || sectorData.length === 0) {
    list.innerHTML = '<div class="small">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  const surge = [];
  sectorData.forEach(s => {
    const it = document.createElement('div');
    it.className = 'item';
    
    const isSurge = s.flow_signal === 'SURGE';
    if (isSurge) surge.push(s.sector);
    else it.classList.add('disabled');
    
    it.innerHTML = `
      <div class="row">
        <b>${s.sector}</b>
        <span class="badge ${isSurge ? 'ok' : 'warn'}">${s.flow_signal}</span>
      </div>
      <div class="small">Flow ${s.flow_score} Â· ${s.duration || '-'}</div>
    `;
    
    if (isSurge) {
      it.onclick = () => {
        $$('.item').forEach(el => el.style.borderColor = 'var(--line)');
        it.style.borderColor = '#3a49a5';
        loadFunnel(s.sector);
      };
    }
    
    list.appendChild(it);
  });
  
  $('#sector-desc').innerText = surge.length
    ? `í˜„ì¬ ìê¸ˆì´ ${surge.join(', ')} ì„¹í„°ë¡œ ì§‘ì¤‘.`
    : 'ëšœë ·í•œ ìê¸ˆ ì§‘ì¤‘ ì„¹í„° ì—†ìŒ.';
}

// ========== Funnel ë°ì´í„°ì— í˜„ì¬ ì£¼ê°€ ì¶”ê°€ (trade_plan_simulation.html ì „ë‹¬ìš©) ==========
async function enrichFunnelDataWithPrices(funnelData) {
  try {
    // stock_prices.jsonì—ì„œ ëª¨ë“  ì¢…ëª©ì˜ í˜„ì¬ ì£¼ê°€ ë¡œë“œ
    const response = await fetch('stock_prices.json');
    if (!response.ok) {
      console.warn('âš ï¸ stock_prices.json ë¡œë“œ ì‹¤íŒ¨ - ê°€ê²© ë°ì´í„° ì—†ì´ ì§„í–‰');
      return;
    }
    
    const priceData = await response.json();
    if (!priceData.stocks) {
      console.warn('âš ï¸ stock_prices.json í˜•ì‹ ì˜¤ë¥˜');
      return;
    }
    
    // funnelDataì˜ ëª¨ë“  ì¹´í…Œê³ ë¦¬(leader, follower, nogo)ì—ì„œ price ì—…ë°ì´íŠ¸
    ['leader', 'follower', 'nogo'].forEach(category => {
      if (funnelData[category] && Array.isArray(funnelData[category])) {
        funnelData[category].forEach(stock => {
          if (priceData.stocks[stock.ticker]) {
            // âœ… stock_prices.jsonì˜ ê°€ê²©ì„ ì¶”ê°€
            stock.price = priceData.stocks[stock.ticker].price;
            console.log(`ğŸ’° ${stock.ticker} (${stock.name}): â‚©${stock.price}`);
          } else {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ì‚¬ìš©ìê°€ ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥)
            stock.price = stock.price || 0;
            console.warn(`âš ï¸ ${stock.ticker}: stock_prices.jsonì— ë°ì´í„° ì—†ìŒ`);
          }
        });
      }
    });
    
    console.log('âœ… Funnel ë°ì´í„°ì— í˜„ì¬ ì£¼ê°€ ì¶”ê°€ ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ enrichFunnelDataWithPrices ì˜¤ë¥˜:', error);
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ: MARKET_DATA ì „ì²´ ê°€ê²© ì—…ë°ì´íŠ¸
async function updateAllMarketDataPrices() {
  try {
    console.log('ğŸ“Š stock_prices.jsonì—ì„œ ëª¨ë“  ì£¼ê°€ ë¡œë“œ ì¤‘...');
    const response = await fetch('stock_prices.json');
    if (!response.ok) {
      console.warn('âš ï¸ stock_prices.json ë¡œë“œ ì‹¤íŒ¨');
      return;
    }
    
    const priceData = await response.json();
    if (!priceData.stocks) {
      console.warn('âš ï¸ stock_prices.json í˜•ì‹ ì˜¤ë¥˜');
      return;
    }
    
    // MARKET_DATA.funnelsì˜ ëª¨ë“  ì„¹í„°ì—ì„œ ê°€ê²© ì—…ë°ì´íŠ¸
    Object.values(MARKET_DATA.funnels).forEach(funnel => {
      ['leader', 'follower', 'nogo'].forEach(category => {
        if (funnel[category] && Array.isArray(funnel[category])) {
          funnel[category].forEach(stock => {
            if (priceData.stocks[stock.ticker]) {
              const oldPrice = stock.price;
              stock.price = priceData.stocks[stock.ticker].price;
              if (oldPrice !== stock.price) {
                console.log(`ğŸ”„ ${stock.ticker}: ${oldPrice} â†’ ${stock.price}`);
              }
            }
          });
        }
      });
    });
    
    console.log('âœ… ëª¨ë“  MARKET_DATA ì£¼ê°€ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ updateAllMarketDataPrices ì˜¤ë¥˜:', error);
  }
}

// ========== 3. Funnel ==========
async function loadFunnel(sector) {
  selectedSector = sector;
  $('#funnel-status').innerText = `ì„ íƒ ì„¹í„°: ${sector}`;
  
  $('#leader').innerHTML = '<div class="loading">ë¡œë”©ì¤‘...</div>';
  $('#follower').innerHTML = '<div class="loading">ë¡œë”©ì¤‘...</div>';
  $('#nogo').innerHTML = '<div class="loading">ë¡œë”©ì¤‘...</div>';
  
  funnelData = await fetchJSON(withKey(`/funnel?sector=${encodeURIComponent(sector)}`));
  
  if (!funnelData) {
    $('#leader').innerHTML = '<div class="small">ë°ì´í„° ì—†ìŒ</div>';
    $('#follower').innerHTML = '<div class="small">ë°ì´í„° ì—†ìŒ</div>';
    $('#nogo').innerHTML = '<div class="small">ë°ì´í„° ì—†ìŒ</div>';
    return;
  }
  
  // âœ… Funnel ë°ì´í„°ì— í˜„ì¬ ì£¼ê°€ ì¶”ê°€ (trade_plan_simulation.html ì „ë‹¬ìš©) - await ì²˜ë¦¬
  await enrichFunnelDataWithPrices(funnelData);
  
  const addStock = (boxId, stocks, funnelType) => {
    const box = $(boxId);
    box.innerHTML = '';
    
    if (!stocks || stocks.length === 0) {
      box.innerHTML = '<div class="small">-</div>';
      return;
    }
    
    stocks.forEach(stock => {
      const it = document.createElement('div');
      it.className = 'item';
      
      // No-GoëŠ” ë¹¨ê°„ìƒ‰ ìŠ¤íƒ€ì¼ + ê²½ê³  ì•„ì´ì½˜
      if (funnelType === 'NO_GO') {
        it.style.borderColor = '#ff4d4d';
        it.style.background = 'rgba(255,77,77,0.05)';
        it.innerHTML = `
          <b style="color:#ff4d4d;">âš ï¸ ${stock.name || stock.ticker}</b><br>
          <small style="color:#ff9999;">${stock.ticker}</small><br>
          <small style="color:#aab3d6; font-size:10px; margin-top:4px; display:block;">
            ${stock.reason || 'íšŒí”¼ ëŒ€ìƒ'}
          </small>
        `;
        
        // No-Go í´ë¦­ ì‹œ ìƒì„¸ ì´ìœ  í‘œì‹œ
        it.onclick = () => {
          $$('.item').forEach(el => el.style.borderColor = el.style.borderColor || 'var(--line)');
          it.style.borderColor = '#ff4d4d';
          displayNoGoReason(stock);
        };
      } else {
        it.innerHTML = `<b>${stock.name || stock.ticker}</b><br><small>${stock.ticker}</small>`;
        
        it.onclick = () => {
          selectedStock = {...stock, type: funnelType};  // íƒ€ì… ì €ì¥
          $$('.item').forEach(el => el.style.borderColor = 'var(--line)');
          it.style.borderColor = '#3a49a5';
          
          // Watch & Checklist í‘œì‹œ
          displayChecklist(stock, funnelType);
        };
      }
      
      box.appendChild(it);
    });
  };
  
  addStock('#leader', funnelData.leader, 'LEADER');
  addStock('#follower', funnelData.follower, 'FOLLOWER');
  addStock('#nogo', funnelData.nogo, 'NO_GO');
  
  $('#funnel-desc').innerText = funnelData.leader && funnelData.leader.length
    ? 'ì„ ë„ì£¼ í˜•ì„±. ëˆŒë¦¼ ë§¤ìˆ˜ êµ¬ê°„.'
    : funnelData.follower && funnelData.follower.length
    ? 'ì„¹í„°ëŠ” ê°•í•˜ë‚˜ ì•„ì§ ëŒíŒŒ ì „.'
    : 'ë§¤ìˆ˜ í™•ë¥ ì´ ë‚®ì€ ì„¹í„°.';
}

// ========== Market Intelligence (ìë™ ìƒì„± - ì „ë¬¸ê°€ ìˆ˜ì¤€ ë¶„ì„) ==========
async function generateMarketIntelligence() {
  const box = $('#market-intelligence');
  if (!box) return;
  
  try {
    // APIì—ì„œ ì‹œì¥ í•´ì„¤ ê°€ì ¸ì˜¤ê¸°
    const intelligence = await fetchJSON(withKey('/market_intelligence'));
    
    if (intelligence && intelligence.script) {
      box.innerHTML = intelligence.script.replace(/\n/g, '<br>');
      return;
    }
    
    // ë¡œì»¬ ë°ì´í„°ë¡œ ì „ë¬¸ê°€ê¸‰ ìë™ ë¶„ì„ ìƒì„±
    if (!regimeData) {
      box.innerHTML = 'âš ï¸ ì‹œì¥ ë°ì´í„° ë¡œë”© ì¤‘...';
      return;
    }
    
    let script = '';
    
    // 1) Regime ë¶„ì„ (ì™œ ì´ í™˜ê²½ì´ ì¤‘ìš”í•œê°€)
    script += `<b>1ï¸âƒ£ í˜„ì¬ ì‹œì¥ í™˜ê²½</b><br><br>`;
    script += `<b>${regimeData.state}</b> (${regimeData.score}/${regimeData.max_score})<br>`;
    script += `Playbook: <b>${regimeData.playbook}</b><br><br>`;
    
    if (regimeData.state === 'RISK_ON' && regimeData.score >= 2) {
      script += `âœ… <b>í†µê³„ì ìœ¼ë¡œ ê°€ì¥ ëˆ ë²Œê¸° ì‰¬ìš´ êµ¬ê°„</b><br><br>`;
      script += `ì´ìœ :<br>`;
      script += `â€¢ RISK_ON = ì£¼ì‹ ë¹„ì¤‘ ëŠ˜ë¦¬ëŠ” êµ­ë©´<br>`;
      if (regimeData.factors?.volatility) {
        script += `â€¢ ë³€ë™ì„± ì•ˆì • = íŒ¨ë‹‰ ë§¤ë„ ì—†ìŒ<br>`;
      }
      if (regimeData.factors?.breadth) {
        script += `â€¢ ì‹œì¥ í™•ì‚° = ì¼ë¶€ ì¢…ëª© ì°©ì‹œ ì•„ë‹˜<br>`;
      }
      script += `<br>ğŸ‘‰ ì´ë•ŒëŠ” <b>ì„¹í„° ë¦¬ë”</b>ê°€ ê³„ì† ëˆì„ ë¹¨ì•„ë“¤ì„<br>`;
      script += `ğŸ‘‰ ${regimeData.playbook} = ì¶”ê²© ë§¤ìˆ˜ ì•„ë‹Œ <b>ëˆŒë¦¼ ë§¤ìˆ˜</b>ê°€ ì •ë‹µ<br><br>`;
    } else if (regimeData.state === 'RISK_OFF') {
      script += `âš ï¸ <b>ë°©ì–´ êµ­ë©´ - ì§„ì… ê¸ˆì§€</b><br><br>`;
      script += `â€¢ í˜„ê¸ˆ ë¹„ì¤‘ í™•ëŒ€<br>`;
      script += `â€¢ ê¸°ì¡´ í¬ì§€ì…˜ ì†ì ˆ ê²€í† <br>`;
      script += `â€¢ Risk-On ì „í™˜ ëŒ€ê¸°<br><br>`;
    }
    
    // 2) Sector í•´ì„ (ì™œ ì´ ì„¹í„°ë“¤ì¸ê°€)
    if (sectorData && sectorData.length > 0) {
      script += `<b>2ï¸âƒ£ ìê¸ˆì˜ ë°°ì¹˜ (Capital Map)</b><br><br>`;
      
      const surge = sectorData.filter(x => x.flow_signal === 'SURGE');
      
      if (surge.length > 0) {
        script += `<b>ìê¸ˆì´ ì§‘ì¤‘ë˜ëŠ” ê³³:</b><br>`;
        surge.forEach(s => {
          script += `â€¢ ${s.sector} (${s.flow_score}ì ) - ${s.duration}<br>`;
        });
        script += `<br>`;
        
        // ì„¹í„° ì¡°í•© í•´ì„
        const sectors = surge.map(s => s.sector);
        if (sectors.includes('ë°©ì‚°') && sectors.includes('í—¬ìŠ¤ì¼€ì–´')) {
          script += `<b>ğŸ“Œ ì´ ì¡°í•©ì˜ ì˜ë¯¸:</b><br>`;
          script += `â€¢ <b>ê³µê²© ìê¸ˆ</b> â†’ ë°©ì‚° (ì§€ì •í•™ ë¦¬ìŠ¤í¬ë¥¼ ìˆ˜ìµìœ¼ë¡œ)<br>`;
          script += `â€¢ <b>ë°©ì–´ ìê¸ˆ</b> â†’ í—¬ìŠ¤ì¼€ì–´ (ê²½ê¸° ë‘”í™” ëŒ€ë¹„ í˜„ê¸ˆíë¦„)<br><br>`;
          script += `ğŸ‘‰ ê¸€ë¡œë²Œ ìì‚°ë°°ë¶„ ë¡œì§: <b>ì „ìŸÂ·ê¸ˆë¦¬ í”¼í¬Â·ê²½ê¸° ë‘”í™” ë™ì‹œ ë°˜ì˜</b><br><br>`;
        } else if (sectors.includes('ë°©ì‚°')) {
          script += `<b>ğŸ“Œ ë°©ì‚° ì§‘ì¤‘:</b> ì§€ì •í•™ì  ìœ„í—˜ì´ íˆ¬ì ê¸°íšŒë¡œ ì „í™˜ ì¤‘<br><br>`;
        } else if (sectors.includes('í—¬ìŠ¤ì¼€ì–´')) {
          script += `<b>ğŸ“Œ í—¬ìŠ¤ì¼€ì–´ ì§‘ì¤‘:</b> ë°©ì–´ì  í¬ì§€ì…”ë‹ ê°•í™”<br><br>`;
        }
      }
    }
    
    // 3) Stock Funnel í•µì‹¬ êµ¬ì¡° ë¶„ì„
    if (funnelData && selectedSector) {
      script += `<b>3ï¸âƒ£ ${selectedSector} ì„¹í„° êµ¬ì¡°</b><br><br>`;
      
      const leaders = funnelData.leader || [];
      const followers = funnelData.follower || [];
      
      script += `Leader: ${leaders.length > 0 ? leaders.map(x => x.name || x.ticker).join(', ') : '<b>ì—†ìŒ</b>'}<br>`;
      script += `Follower: ${followers.length > 0 ? followers.map(x => x.name || x.ticker).join(', ') : '<b>ì—†ìŒ</b>'}<br><br>`;
      
      // êµ¬ì¡°ë³„ ì •ë°€ í•´ì„
      if (leaders.length === 0 && followers.length > 0) {
        script += `<b>ğŸ¯ ë§¤ìš° ì¤‘ìš”í•œ êµ¬ì¡° (ìµœê³  ìˆ˜ìµë¥  ë‹¨ê³„)</b><br><br>`;
        script += `<b>ì„¹í„°ëŠ” ë‹¬ë¦¬ëŠ”ë°, ì¢…ëª©ì€ ì•„ì§ ì•ˆ í„°ì§</b><br><br>`;
        script += `ì¼ë°˜ì  ìˆœì„œ:<br>`;
        script += `1) ì„¹í„° ìê¸ˆ ìœ ì… âœ…<br>`;
        script += `2) <b>Follower ê¸‰ë“± â† ì§€ê¸ˆ ì—¬ê¸°</b><br>`;
        script += `3) Leader í™•ì •<br>`;
        script += `4) ê°œì¸ ëª°ë¦¼ â†’ ë<br><br>`;
        script += `ğŸ‘‰ ${followers.map(x => x.name || x.ticker).join(', ')}ê°€ Follower = <b>ë‹¤ìŒ ë¦¬ë” í›„ë³´</b><br>`;
        script += `ğŸ‘‰ ì „ëµ: <b>ëŒíŒŒ ì¶”ê²© ì•„ë‹Œ, ëˆŒë¦¼ì—ì„œ ì¡°ìš©íˆ ë§¤ì§‘</b><br><br>`;
      } else if (leaders.length > 0 && followers.length === 0) {
        const leaderName = leaders[0].name || leaders[0].ticker;
        script += `<b>ğŸ“Œ ìê¸ˆ ì§‘ì¤‘ êµ¬ì¡°</b><br><br>`;
        script += `â€¢ ${leaderName}ì—ë§Œ ìê¸ˆ ì§‘ì¤‘<br>`;
        script += `â€¢ ì„¹í„° í™•ì‚° ì•„ì§ ì•ˆ ë¨<br><br>`;
        
        if (selectedSector === 'í—¬ìŠ¤ì¼€ì–´' || leaderName.includes('JNJ')) {
          script += `<b>JNJì˜ ì˜ë¯¸:</b><br>`;
          script += `â€¢ í˜„ê¸ˆíë¦„ + ë°°ë‹¹ + ê¸€ë¡œë²Œ ë°©ì–´ ìì‚°<br>`;
          script += `â€¢ ê¸°ê´€ì˜ "ì•ˆì „í•œ í”¼ë‚œì²˜" í¬ì§€ì…˜<br><br>`;
          script += `ğŸ‘‰ íŠ¸ë ˆì´ë”© ì•„ë‹Œ <b>í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆì •í™”</b><br>`;
          script += `ğŸ‘‰ ì „ëµ: ëˆŒë¦¼ë³´ë‹¤ <b>ì¶”ì„¸ ì¶”ì¢…</b>ì´ ë§ìŒ<br><br>`;
        } else {
          script += `ğŸ‘‰ ì „ëµ: <b>ì•ˆì •í˜•Â·ë°©ì–´í˜• íŠ¸ë ˆì´ë“œ ìµœì </b><br><br>`;
        }
      } else if (leaders.length > 0 && followers.length > 0) {
        script += `<b>ğŸ“Œ ì„¹í„° ì „ì²´ ìƒìŠ¹ êµ­ë©´</b><br><br>`;
        script += `â€¢ ì„ ë„ì£¼ê°€ ì´ëŒê³  ì¶”ì¢…ì£¼ê°€ ë”°ë¼ì˜´<br>`;
        script += `â€¢ Leader: ì¶”ê²© ì£¼ì˜ (ì´ë¯¸ ë§ì´ ì˜¤ë¦„)<br>`;
        script += `â€¢ Follower: <b>ëˆŒë¦¼ ë§¤ìˆ˜ íƒ€ì´ë°</b><br><br>`;
      }
    }
    
    // 4) ì‹¤ì „ ì „ëµ (íˆ¬ì ì„±í–¥ë³„)
    script += `<b>4ï¸âƒ£ ì‹¤ì „ ì „ëµ (ì„±í–¥ë³„)</b><br><br>`;
    
    if (regimeData.state === 'RISK_ON' && sectorData) {
      const surge = sectorData.filter(x => x.flow_signal === 'SURGE');
      
      if (surge.length > 0 && funnelData && selectedSector) {
        const followers = funnelData.follower || [];
        const leaders = funnelData.leader || [];
        
        if (followers.length > 0) {
          script += `<b>ê³µê²©ì :</b> ${selectedSector} â†’ `;
          script += `${followers.slice(0, 2).map(x => x.name || x.ticker).join(', ')} <b>ëˆŒë¦¼ ë§¤ìˆ˜ ëŒ€ê¸°</b><br>`;
        }
        
        if (leaders.length > 0) {
          const leaderName = leaders[0].name || leaders[0].ticker;
          if (selectedSector === 'í—¬ìŠ¤ì¼€ì–´' || leaderName.includes('JNJ')) {
            script += `<b>ì•ˆì •ì :</b> ${leaderName} <b>ì¶”ì„¸ ì¶”ì¢…</b> (íƒ€ì´ë°ë³´ë‹¤ ë³´ìœ )<br>`;
          } else {
            script += `<b>ì•ˆì •ì :</b> ${leaderName} ì¶”ì„¸ ì¶”ì¢…<br>`;
          }
        }
        
        script += `<b>í˜„ê¸ˆ ë§ìŒ:</b> ê°ì‹œë§Œ, <b>ì¶”ê²© ê¸ˆì§€</b><br><br>`;
      }
      
      script += `<b>ğŸ¯ í•µì‹¬:</b><br>`;
      script += `ì•„ë¬´ê±°ë‚˜ ì‚¬ëŠ” ì¥ì´ ì•„ë‹ˆë¼<br>`;
      script += `<b>"ìê¸ˆì´ ëª°ë¦¬ëŠ” ì„¹í„° ì•ˆì—ì„œ, ëˆŒë¦¼ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¥"</b><br><br>`;
      
      // ì‹œì¥ êµ¬ì¡° í•œ ë¬¸ì¥ ìš”ì•½
      if (surge.length >= 2) {
        const sectors = surge.map(s => s.sector);
        if (sectors.includes('ë°©ì‚°') && sectors.includes('í—¬ìŠ¤ì¼€ì–´')) {
          script += `<b>ğŸ“Š í˜„ì¬ ì‹œì¥ êµ¬ì¡°:</b><br>`;
          script += `<b>"ê³µê²© ìê¸ˆì€ ë°©ì‚°ìœ¼ë¡œ, ë°©ì–´ ìê¸ˆì€ í—¬ìŠ¤ì¼€ì–´ë¡œ ì´ë™ ì¤‘ì¸ Risk-On ì¥"</b>`;
        }
      }
    } else {
      script += `<b>í˜„ì¬ ì „ëµ:</b> ê´€ë§ / í˜„ê¸ˆ ëŒ€ê¸°<br>`;
      script += `Risk-Off êµ¬ê°„ = ì§„ì… ê¸ˆì§€`;
    }
    
    box.innerHTML = script;
    
  } catch (error) {
    console.error('Market Intelligence Error:', error);
    box.innerHTML = 'âŒ ë¶„ì„ ìƒì„± ì‹¤íŒ¨';
  }
}

// ========== 4. Watch & Checklist ==========

const STATE_CONFIG = {
  BUY_NOW: {
    color: '#4A90E2',
    icon: 'ğŸ”µ',
    label: 'ë§¤ìˆ˜ ê°€ëŠ¥',
    class: 'state-buy-now',
    message: 'ì¦‰ì‹œ ë˜ëŠ” ë¶„í•  ë§¤ìˆ˜ ê°€ëŠ¥ êµ¬ê°„ì…ë‹ˆë‹¤.'
  },
  BUY_PULLBACK: {
    color: '#52D27D',
    icon: 'ğŸŸ¢',
    label: 'ëˆŒë¦¼ ëŒ€ê¸°',
    class: 'state-buy-pullback',
    message: 'ì¶”ê²©ì´ ì•„ë‹ˆë¼ ëˆŒë¦¼ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.'
  },
  ACCUMULATE: {
    color: '#FFB84D',
    icon: 'ğŸŸ¡',
    label: 'ì„ ì œ ë§¤ì§‘',
    class: 'state-accumulate',
    message: 'ë¯¸ë˜ Leader í›„ë³´ë¡œ ì„ ì œ ë§¤ì§‘ êµ¬ê°„ì…ë‹ˆë‹¤.'
  },
  WATCH: {
    color: '#AAB3D6',
    icon: 'âšª',
    label: 'ê´€ì°°',
    class: 'state-watch',
    message: 'ê´€ì°°í•˜ë©° íƒ€ì´ë°ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.'
  },
  HOLD_OFF: {
    color: '#FF9A66',
    icon: 'ğŸŸ ',
    label: 'ë³´ë¥˜',
    class: 'state-hold-off',
    message: 'ë¦¬ìŠ¤í¬ ìš”ì¸ì´ ìˆì–´ ë§¤ìˆ˜ë¥¼ ë³´ë¥˜í•©ë‹ˆë‹¤.'
  },
  NO_GO: {
    color: '#FF4D4D',
    icon: 'ğŸ”´',
    label: 'ë§¤ìˆ˜ ê¸ˆì§€',
    class: 'state-no-go',
    message: 'êµ¬ì¡°ì ìœ¼ë¡œ ë§¤ìˆ˜ ê¸ˆì§€ì…ë‹ˆë‹¤.'
  }
};

function checkSafetyChecklist(stock, funnelType) {
  /**
   * 5ê°€ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸
   * "ì‚¬ë©´ ì•ˆ ë˜ëŠ” ì´ìœ ê°€ ìˆëŠ”ê°€?"
   */
  const checks = {
    priceStructure: false,  // ê°€ê²© êµ¬ì¡° (ê³¼ì—´/ì´ê²© ì—†ìŒ)
    volume: false,          // ê±°ë˜ëŸ‰ ì •ìƒ
    volatility: false,      // ë³€ë™ì„± ì•ˆì •
    eventRisk: false,       // ì´ë²¤íŠ¸ ë¦¬ìŠ¤í¬ ì—†ìŒ
    pullback: false         // êµ¬ì¡°ì  ëˆŒë¦¼
  };
  
  // Mock ì²´í¬ (ì‹¤ì œë¡œëŠ” ì°¨íŠ¸ ë°ì´í„°ë¡œ ê³„ì‚°)
  // ì˜ˆì‹œ: LMT, í•œí™”ì—ì–´ë¡œ ë“±ì€ í†µê³¼, ì¼ë¶€ëŠ” ì‹¤íŒ¨
  if (stock.ticker === 'LMT' || stock.ticker === '012450') {
    checks.priceStructure = true;
    checks.volume = true;
    checks.volatility = true;
    checks.eventRisk = true;
    checks.pullback = true;
  } else if (stock.ticker === 'JNJ') {
    checks.priceStructure = true;
    checks.volume = true;
    checks.volatility = true;
    checks.eventRisk = true;
    checks.pullback = false; // ëˆŒë¦¼ ì•„ë‹˜
  } else {
    checks.priceStructure = Math.random() > 0.3;
    checks.volume = Math.random() > 0.3;
    checks.volatility = Math.random() > 0.3;
    checks.eventRisk = Math.random() > 0.5;
    checks.pullback = Math.random() > 0.4;
  }
  
  const passCount = Object.values(checks).filter(v => v).length;
  
  let checklistLevel;
  if (passCount === 5) {
    checklistLevel = 'Strong';
  } else if (passCount === 4) {
    checklistLevel = 'Medium';
  } else {
    checklistLevel = 'Weak';
  }
  
  return { checks, passCount, checklistLevel };
}

function determineState(funnelType, checklistLevel) {
  /**
   * Funnel Ã— Checklist â†’ State ê²°ì •
   */
  if (funnelType === 'NO_GO') {
    return 'NO_GO';
  }
  
  if (funnelType === 'LEADER') {
    if (checklistLevel === 'Strong') return 'BUY_NOW';
    if (checklistLevel === 'Medium') return 'BUY_PULLBACK';
    return 'HOLD_OFF';
  }
  
  if (funnelType === 'FOLLOWER') {
    if (checklistLevel === 'Strong') return 'ACCUMULATE';
    if (checklistLevel === 'Medium') return 'WATCH';
    return 'HOLD_OFF';
  }
  
  return 'WATCH';
}

function displayChecklist(stock, funnelType) {
  const box = $('#checklist-result');
  if (!box) return;
  
  const { checks, passCount, checklistLevel } = checkSafetyChecklist(stock, funnelType);
  const state = determineState(funnelType, checklistLevel);
  const config = STATE_CONFIG[state];
  
  $('#checklist-status').innerText = `ì„ íƒ: ${stock.name || stock.ticker} (${funnelType})`;
  
  let html = `
    <div class="state-badge ${config.class}">
      ${config.icon} ${config.label}
    </div>
    <p style="font-size:13px; color:#aab3d6; margin-bottom:15px;">
      ${config.message}
    </p>
    <div class="small" style="margin-bottom:8px;">
      <b>Checklist: ${passCount}/5 (${checklistLevel})</b>
    </div>
    <div class="checklist-grid">
  `;
  
  const checkItems = [
    { key: 'priceStructure', label: 'ê°€ê²© êµ¬ì¡° (ê³¼ì—´/ì´ê²© ì—†ìŒ)' },
    { key: 'volume', label: 'ê±°ë˜ëŸ‰ ì •ìƒ' },
    { key: 'volatility', label: 'ë³€ë™ì„± ì•ˆì •' },
    { key: 'eventRisk', label: 'ì´ë²¤íŠ¸ ë¦¬ìŠ¤í¬ ì—†ìŒ' },
    { key: 'pullback', label: 'êµ¬ì¡°ì  ëˆŒë¦¼ êµ¬ê°„' }
  ];
  
  checkItems.forEach(item => {
    const pass = checks[item.key];
    html += `
      <div class="check-item ${pass ? 'pass' : 'fail'}">
        <div class="check-icon">${pass ? 'âœ…' : 'âŒ'}</div>
        <div class="check-text">${item.label}</div>
      </div>
    `;
  });
  
  html += '</div>';
  
  // 9ìš”ì†Œ ì ìˆ˜ í‘œì‹œ (í´ë¦­ ê°€ëŠ¥)
  html += `
    <div class="sep"></div>
    <div class="small" style="margin-bottom:8px;">
      <b>ğŸ’¯ 9ìš”ì†Œ ì ìˆ˜ (í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°)</b>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
      <div onclick="openWhyDrawer('flow', selectedStock)" 
           style="padding:8px; background:rgba(102,126,234,0.1); border-radius:6px; cursor:pointer; transition:all 0.2s;"
           onmouseover="this.style.background='rgba(102,126,234,0.2)'"
           onmouseout="this.style.background='rgba(102,126,234,0.1)'">
        <div style="font-size:11px; color:#aab3d6;">ìê¸ˆ íë¦„</div>
        <div style="font-size:18px; font-weight:700; color:#667eea;">85 <span style="font-size:11px; opacity:0.7;">/100</span></div>
      </div>
      <div onclick="openWhyDrawer('structure', selectedStock)" 
           style="padding:8px; background:rgba(102,126,234,0.1); border-radius:6px; cursor:pointer; transition:all 0.2s;"
           onmouseover="this.style.background='rgba(102,126,234,0.2)'"
           onmouseout="this.style.background='rgba(102,126,234,0.1)'">
        <div style="font-size:11px; color:#aab3d6;">ê°€ê²© êµ¬ì¡°</div>
        <div style="font-size:18px; font-weight:700; color:#667eea;">78 <span style="font-size:11px; opacity:0.7;">/100</span></div>
      </div>
      <div onclick="openWhyDrawer('narrative', selectedStock)" 
           style="padding:8px; background:rgba(102,126,234,0.1); border-radius:6px; cursor:pointer; transition:all 0.2s;"
           onmouseover="this.style.background='rgba(102,126,234,0.2)'"
           onmouseout="this.style.background='rgba(102,126,234,0.1)'">
        <div style="font-size:11px; color:#aab3d6;">ì„œì‚¬</div>
        <div style="font-size:18px; font-weight:700; color:#667eea;">72 <span style="font-size:11px; opacity:0.7;">/100</span></div>
      </div>
      <div onclick="openWhyDrawer('risk', selectedStock)" 
           style="padding:8px; background:rgba(239,68,68,0.1); border-radius:6px; cursor:pointer; transition:all 0.2s;"
           onmouseover="this.style.background='rgba(239,68,68,0.2)'"
           onmouseout="this.style.background='rgba(239,68,68,0.1)'">
        <div style="font-size:11px; color:#aab3d6;">ë¦¬ìŠ¤í¬</div>
        <div style="font-size:18px; font-weight:700; color:#ef4444;">25 <span style="font-size:11px; opacity:0.7;">/100</span></div>
      </div>
    </div>
  `;
  
  // ìƒíƒœë³„ ì¶”ê°€ ë©˜íŠ¸
  if (funnelType === 'LEADER' && state === 'BUY_NOW') {
    html += `
      <div class="sep"></div>
      <div class="small" style="color:#4A90E2;">
        ğŸ’¡ Leader + Checklist ì™„ë²½ â†’ ì¦‰ì‹œ/ë¶„í•  ë§¤ìˆ˜ ê°€ëŠ¥
      </div>
    `;
  } else if (funnelType === 'FOLLOWER' && state === 'ACCUMULATE') {
    html += `
      <div class="sep"></div>
      <div class="small" style="color:#FFB84D;">
        ğŸ’¡ Follower + Checklist Strong â†’ ì„ ì œ ë§¤ì§‘ (ë¯¸ë˜ Leader í›„ë³´)
      </div>
    `;
  } else if (state === 'HOLD_OFF') {
    html += `
      <div class="sep"></div>
      <div class="small" style="color:#FF9A66;">
        âš ï¸ Checklist ë¶€ì¡± â†’ ë§¤ìˆ˜ ë³´ë¥˜ ê¶Œì¥
      </div>
    `;
  }
  
  box.innerHTML = html;
  
  // Trade Plan ìƒì„±
  buildTradePlan(stock, funnelType);
}

// No-Go ìƒì„¸ ì´ìœ  í‘œì‹œ
function displayNoGoReason(stock) {
  const box = $('#checklist-result');
  const statusBox = $('#checklist-status');
  
  if (!box || !statusBox) return;
  
  statusBox.innerText = `ì„ íƒ: ${stock.name || stock.ticker} (NO-GO)`;
  
  const reasons = stock.reasons || [stock.reason || 'íšŒí”¼ ëŒ€ìƒ'];
  
  let html = `
    <div class="state-badge state-no-go">
      ğŸ”´ ë§¤ìˆ˜ ê¸ˆì§€
    </div>
    <p style="font-size:13px; color:#ff9999; margin-bottom:15px; line-height:1.6;">
      ì´ ì¢…ëª©ì€ ë‹¤ìŒ ì´ìœ ë¡œ <b>êµ¬ì¡°ì ìœ¼ë¡œ ë§¤ìˆ˜ ê¸ˆì§€</b>ì…ë‹ˆë‹¤.
    </p>
    
    <div class="plan-section" style="border-left-color:#ff4d4d;">
      <h4 style="color:#ff4d4d;">âš ï¸ íšŒí”¼ ì‚¬ìœ </h4>
  `;
  
  reasons.forEach((reason, idx) => {
    html += `
      <div class="plan-row">
        <span class="plan-label">${idx + 1}.</span>
        <span class="plan-value bearish">${reason}</span>
      </div>
    `;
  });
  
  html += `
    </div>
    
    <div class="small" style="color:#aab3d6; line-height:1.6; margin-top:12px;">
      <b>ğŸ’¡ ì™œ No-Goì¸ê°€?</b><br><br>
      â€¢ ë‹¨ì¼ ê¸°ì‚¬ ê¸‰ë“±: ë£¨ë¨¸ ê°€ëŠ¥ì„±<br>
      â€¢ ê°­ í›„ ì¥ëŒ€ ìŒë´‰: ë¶„ë°° ì‹ í˜¸<br>
      â€¢ í…Œë§ˆ 5ë²ˆì§¸ ì´í›„: í›„ë°œì£¼ ìœ„í—˜<br>
      â€¢ ê°œì¸ 80%+ê¸°ê´€ ì´íƒˆ: ì§€ì†ì„± ë‚®ìŒ<br>
      â€¢ ì´í‰ì„  ë™ì‹œ ì´íƒˆ: ì•½ì„¸ ì „í™˜<br>
      â€¢ ì†ì ˆì„  ì„¤ì • ë¶ˆê°€: ë³€ë™ì„± ê³¼ë‹¤<br><br>
      
      <b style="color:#ff4d4d;">â†’ ì´ëŸ° ì¢…ëª©ì€ "ì™œ ì˜¤ë¥¼ê¹Œ?"ê°€ ì•„ë‹ˆë¼ "ì™œ ê¸‰ë½í• ê¹Œ?"ë¥¼ ë¨¼ì € ê³ ë¯¼í•´ì•¼ í•©ë‹ˆë‹¤.</b>
    </div>
  `;
  
  box.innerHTML = html;
  
  // Trade Plan ì¹´ë“œ ìˆ¨ê¸°ê¸°
  const tradePlanCard = $('#trade-plan-card');
  if (tradePlanCard) {
    tradePlanCard.style.display = 'none';
  }
}

// ========== 5. Trade Plan Builder ==========

function buildTradePlan(stock, funnelType) {
  /**
   * ë§¤ë§¤ ê³„íš ìë™ ìƒì„±
   * í•µì‹¬: ì†ì ˆ ë¨¼ì € ê³ ì • â†’ ì§„ì… â†’ ëª©í‘œ
   */
  const card = $('#trade-plan-card');
  const resultBox = $('#plan-result');
  
  if (!card || !resultBox || !stock) return;
  
  // ì¹´ë“œ í‘œì‹œ
  card.style.display = 'block';
  
  // ì‚¬ìš©ì ì…ë ¥
  const period = $('#plan-period').value || 'ì¤‘ê¸°';
  const risk = $('#plan-risk').value || 'ì¤‘ë¦½';
  
  // í†µí™” ê°ì§€
  const currency = stock.currency || detectCurrency(stock.ticker);
  
  // ì†ì ˆ ë¨¼ì € ê³„ì‚° (êµ¬ì¡° ê¸°ë°˜)
  const price = stock.price || 185000;
  const ma20 = stock.ma20 || price * 0.97;
  const support = Math.min(ma20, price * 0.95);  // 20ì¼ì„  or 5% ì•„ë˜
  const stopLoss = Math.floor(support * 0.97);   // ì§€ì§€ì„  -3%
  
  // ì§„ì… 2ì•ˆ
  const entryBreakout = Math.ceil(price * 1.01);  // ëŒíŒŒ ì§„ì… (+1%)
  const entryPullback = Math.floor(ma20);          // ëˆŒë¦¼ ë§¤ìˆ˜ (20ì¼ì„ )
  
  // ë¦¬ìŠ¤í¬ ê¸ˆì•¡
  const riskAmount = price - stopLoss;
  
  // ë¦¬ìŠ¤í¬ ì„±í–¥ë³„ ë°°ìˆ˜
  const riskReward = {
    'ë³´ìˆ˜': 2.0,
    'ì¤‘ë¦½': 2.5,
    'ê³µê²©': 3.0
  };
  
  const multiplier = riskReward[risk] || 2.5;
  
  // ëª©í‘œ 2ì•ˆ
  const targetConservative = Math.ceil(price + riskAmount * multiplier);
  const targetAggressive = Math.ceil(price + riskAmount * multiplier * 1.5);
  
  // í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ (ë³€ë™ì„± ê¸°ë°˜)
  const volatility = stock.volatility || 0.08;  // 8% ë³€ë™ì„± ê°€ì •
  let positionSize = volatility < 0.1 ? 0.25 : 0.20;  // 25% or 20%
  
  if (risk === 'ë³´ìˆ˜') positionSize *= 0.8;
  if (risk === 'ê³µê²©') positionSize *= 1.2;
  
  positionSize = Math.round(positionSize * 100);
  
  // ìµœëŒ€ ë³´ìœ  ê¸°ê°„
  const maxHoldingDays = period === 'ë‹¨ê¸°' ? 10 : 60;
  
  // HTML ìƒì„±
  let html = `
    <div class="small" style="margin-bottom:12px; color:var(--muted);">
      ${period} / ${risk} ì„±í–¥ ê¸°ì¤€
    </div>
    
    <div class="plan-section">
      <h4>ğŸ“ ì§„ì… 2ì•ˆ</h4>
      <div class="plan-row">
        <span class="plan-label">âœ“ ëŒíŒŒ ì§„ì…</span>
        <span class="plan-value bullish">${formatPrice(entryBreakout, currency)}</span>
      </div>
      <div class="plan-row">
        <span class="plan-label">âœ“ ëˆŒë¦¼ ë§¤ìˆ˜</span>
        <span class="plan-value bullish">${formatPrice(entryPullback, currency)}</span>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        ğŸ’¡ ìµœê·¼ ê³ ì  ëŒíŒŒ ì‹œ ë˜ëŠ” 20ì¼ì„  ì§€ì§€ ì‹œ
      </div>
    </div>
    
    <div class="plan-section">
      <h4>âœ— ì†ì ˆ (ë¬´ì¡°ê±´)</h4>
      <div class="plan-row">
        <span class="plan-label">êµ¬ì¡° ì´íƒˆ ì‹œ</span>
        <span class="plan-value bearish">${formatPrice(stopLoss, currency)}</span>
      </div>
      <div class="small" style="margin-top:8px; color:#ff4d4d;">
        âš ï¸ ì†ì ˆ ì—¬ìœ : ${((riskAmount / price) * 100).toFixed(1)}% (${formatPrice(riskAmount, currency)})
      </div>
    </div>
    
    <div class="plan-section">
      <h4>ğŸ¯ ëª©í‘œ 2ì•ˆ + ë¶„í• </h4>
      <div class="plan-row">
        <span class="plan-label">1ì°¨ ëª©í‘œ (50% ë§¤ë„)</span>
        <span class="plan-value bullish">${formatPrice(targetConservative, currency)}</span>
      </div>
      <div class="plan-row">
        <span class="plan-label">2ì°¨ ëª©í‘œ (30% ë§¤ë„)</span>
        <span class="plan-value bullish">${formatPrice(targetAggressive, currency)}</span>
      </div>
      <div class="plan-row">
        <span class="plan-label">ë‚˜ë¨¸ì§€ 20%</span>
        <span class="plan-value">ì¶”ì„¸ ì¶”ì¢…</span>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        ğŸ’¡ ë¦¬ìŠ¤í¬ ëŒ€ë¹„ ìˆ˜ìµ: 1 : ${multiplier} (${risk} ì„±í–¥)
      </div>
    </div>
    
    <div class="plan-section">
      <h4>ğŸ“Š í¬ì§€ì…˜ ê´€ë¦¬</h4>
      <div class="plan-row">
        <span class="plan-label">ê¶Œì¥ í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ</span>
        <span class="plan-value">${positionSize}%</span>
      </div>
      <div class="plan-row">
        <span class="plan-label">ìµœëŒ€ ë³´ìœ  ê¸°ê°„</span>
        <span class="plan-value">${maxHoldingDays}ì¼</span>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        ğŸ’¡ ë³€ë™ì„± ${(volatility * 100).toFixed(1)}% ê³ ë ¤í•œ ì‚¬ì´ì¦ˆ
      </div>
    </div>
  `;
  
  // Leader/Followerë³„ ì¶”ê°€ ë©˜íŠ¸
  if (funnelType === 'LEADER') {
    html += `
      <div class="sep"></div>
      <div class="small" style="color:#4ade80; line-height:1.6;">
        <b>Leader ì „ëµ:</b><br>
        â€¢ ëŒíŒŒ ë˜ëŠ” ëˆŒë¦¼ ì¤‘ ë¹ ë¥¸ íƒ€ì´ë°<br>
        â€¢ 1ì°¨ ëª©í‘œ 50% ë°˜ë“œì‹œ ìµì ˆ<br>
        â€¢ ë‚˜ë¨¸ì§€ëŠ” ì¶”ì„¸ ì¶”ì¢…
      </div>
    `;
  } else if (funnelType === 'FOLLOWER') {
    html += `
      <div class="sep"></div>
      <div class="small" style="color:#ffb84d; line-height:1.6;">
        <b>Follower ì „ëµ:</b><br>
        â€¢ ëˆŒë¦¼ ë§¤ìˆ˜ë§Œ ì§‘í–‰ (ëŒíŒŒ ì¶”ê²© ê¸ˆì§€)<br>
        â€¢ Leader ì´íƒˆ ì‹œ ì¦‰ì‹œ ì†ì ˆ<br>
        â€¢ ì¸ë‚´ì‹¬ í•„ìš” (1~2ì£¼ ëŒ€ê¸° ê°€ëŠ¥)
      </div>
    `;
  }
  
  resultBox.innerHTML = html;
}

// ========== Trade Plan í†µí•© í•¨ìˆ˜ ==========

/**
 * ìƒì„¸ ì‹œë®¬ë ˆì´ì…˜ í˜ì´ì§€ ì—´ê¸°
 * index.html â†’ trade_plan_simulation.html seamless ì—°ê²°
 */
function openDetailedSimulation() {
  if (!selectedStock) {
    alert('ë¨¼ì € ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  // âœ… DEBUG: selectedStock ìƒíƒœ í™•ì¸
  console.log('ğŸ“‹ selectedStock ìƒíƒœ:', selectedStock);
  console.log('  ticker:', selectedStock.ticker);
  console.log('  name:', selectedStock.name);
  console.log('  price:', selectedStock.price);
  console.log('  type:', selectedStock.type);
  
  // í˜„ì¬ ì„ íƒëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
  const period = $('#plan-period')?.value || 'ì¤‘ê¸°';
  const risk = $('#plan-risk')?.value || 'ì¤‘ë¦½';
  
  // ì‹œì¥ ê²°ì • (í‹°ì»¤ë¡œ íŒë‹¨)
  const ticker = selectedStock.ticker || '';
  const isUSStock = /^[A-Z]+$/.test(ticker) && ticker.length <= 5;
  const market = isUSStock ? 'US' : 'KR';
  
  // Risk ë§¤í•‘ (í•œê¸€ â†’ ì˜ë¬¸)
  const riskMapping = {
    'ë³´ìˆ˜': 'conservative',
    'ì¤‘ë¦½': 'neutral',
    'ê³µê²©': 'aggressive'
  };
  const riskEng = riskMapping[risk] || 'neutral';
  
  // Period ë§¤í•‘
  const periodMapping = {
    'ë‹¨ê¸°': 'ë‹¨ê¸°',
    'ì¤‘ê¸°': 'ì¤‘ê¸°'
  };
  const periodKor = periodMapping[period] || 'ì¤‘ê¸°';
  
  // URL íŒŒë¼ë¯¸í„° ìƒì„±
  const params = new URLSearchParams({
    market: market,
    sector: selectedSector || '',
    ticker: selectedStock.ticker || '',
    name: selectedStock.name || '',
    price: selectedStock.price || '',  // âœ… price ì „ë‹¬
    period: periodKor,
    risk: riskEng,
    capital: '10000000',  // ê¸°ë³¸ 1ì²œë§Œì›
    from: 'index'
  });
  
  // ìƒˆ íƒ­ì—ì„œ ì‹œë®¬ë ˆì´ì…˜ í˜ì´ì§€ ì—´ê¸°
  const url = `trade_plan_simulation.html?${params.toString()}`;
  
  console.log('ğŸ”— ì „ë‹¬ URL:', url);
  console.log('ğŸ“¤ íŒŒë¼ë¯¸í„° ì „ë‹¬:', {
    market: market,
    sector: selectedSector,
    ticker: selectedStock.ticker,
    name: selectedStock.name,
    price: selectedStock.price,
    period: periodKor,
    risk: riskEng
  });
  
  window.open(url, '_blank');
}

/**
 * ì‹¤ì‹œê°„ Trade Plan ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
 * ì‚¬ìš©ìê°€ ê¸°ê°„/ë¦¬ìŠ¤í¬ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜
 */
function updateTradePlan() {
  if (!selectedStock) {
    const resultBox = $('#plan-result');
    if (resultBox) {
      resultBox.innerHTML = `
        <div class="small" style="color:var(--muted); text-align:center; padding:20px;">
          ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.
        </div>
      `;
    }
    return;
  }
  
  // í˜„ì¬ ì„ íƒëœ ì¢…ëª©ì˜ funnelType ê°€ì ¸ì˜¤ê¸°
  const funnelType = selectedStock.type || 'FOLLOWER';
  
  // buildTradePlan ì¬ì‹¤í–‰ (ê¸°ì¡´ í•¨ìˆ˜ í™œìš©)
  buildTradePlan(selectedStock, funnelType);
  
  console.log('ğŸ”„ Trade Plan updated:', {
    stock: selectedStock.name,
    period: $('#plan-period')?.value,
    risk: $('#plan-risk')?.value
  });
}

// ========== Why Drawer + Devil's Advocate ==========

/**
 * Why Drawer ì—´ê¸°
 * ì ìˆ˜ë¥¼ í´ë¦­í•˜ë©´ ê·¼ê±°ì™€ ë°˜ëŒ€ ì˜ê²¬ì„ í‘œì‹œ
 */
function openWhyDrawer(scoreType, stock) {
  console.log('ğŸ” Opening Why Drawer:', scoreType, stock);
  
  // ì ìˆ˜ ë°ì´í„° ìƒì„±
  const scoreData = generateScoreData(scoreType, stock);
  
  // UI ì—…ë°ì´íŠ¸
  $('#drawer-title').innerText = `ğŸ” Why ${scoreData.label}: ${scoreData.score}/100?`;
  $('#drawer-score').innerText = scoreData.score;
  $('#drawer-label').innerText = scoreData.label;
  
  // ì§€ì§€ ê·¼ê±° ë Œë”ë§
  renderSupportingReasons(scoreData.supportingReasons);
  
  // ë°˜ëŒ€ ì˜ê²¬ ë Œë”ë§
  renderCounterArguments(scoreData.counterArguments);
  
  // ì‹ ë¢°ë„ í‘œì‹œ
  $('#confidence-level').innerText = `${scoreData.confidence}%`;
  
  // ëª¨ë‹¬ í‘œì‹œ
  $('#why-drawer').style.display = 'block';
}

/**
 * Why Drawer ë‹«ê¸°
 */
function closeWhyDrawer() {
  $('#why-drawer').style.display = 'none';
}

/**
 * ì ìˆ˜ ë°ì´í„° ìƒì„± (Devil's Advocate ë¡œì§ í¬í•¨)
 */
function generateScoreData(scoreType, stock) {
  const price = stock?.price || 185000;
  const ticker = stock?.ticker || '012450';
  const currency = stock?.currency || detectCurrency(ticker);
  
  // Mock ë°ì´í„° (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì˜´)
  const baseData = {
    flow: {
      score: 85,
      label: 'ìê¸ˆ íë¦„',
      supportingReasons: [
        {
          text: `ì™¸êµ­ì¸ 5ì¼ ëˆ„ì  ìˆœë§¤ìˆ˜ +${(Math.random() * 30 + 10).toFixed(0)}ì–µì›`,
          source: 'KRX íˆ¬ììë³„ ë§¤ë§¤ë™í–¥',
          link: 'http://data.krx.co.kr',
          weight: 15
        },
        {
          text: `ê¸°ê´€ 20ì¼ ëˆ„ì  ìˆœë§¤ìˆ˜ +${(Math.random() * 80 + 40).toFixed(0)}ì–µì›`,
          source: 'KRX íˆ¬ììë³„ ë§¤ë§¤ë™í–¥',
          link: 'http://data.krx.co.kr',
          weight: 15
        },
        {
          text: `ê±°ë˜ëŒ€ê¸ˆ 20ì¼ í‰ê·  ëŒ€ë¹„ +${(Math.random() * 40 + 20).toFixed(0)}%`,
          source: 'KRX ì‹œì¥ë°ì´í„°',
          link: 'http://data.krx.co.kr',
          weight: 20
        }
      ]
    },
    structure: {
      score: 78,
      label: 'ê°€ê²© êµ¬ì¡°',
      supportingReasons: [
        {
          text: '3íšŒ ì—°ì† ê³ ì  ê°±ì‹  (ìƒìŠ¹ ì¶”ì„¸ í™•ë¦½)',
          source: 'ì°¨íŠ¸ ë¶„ì„',
          link: '#',
          weight: 30
        },
        {
          text: `MA20(${formatPrice(Math.floor(price * 0.97), currency)}) ìœ„ ì•ˆì •ì  ê±°ë˜`,
          source: 'ì°¨íŠ¸ ë¶„ì„',
          link: '#',
          weight: 25
        },
        {
          text: 'ì¡°ì • ì‹œ ê±°ë˜ëŸ‰ -40% ê°ì†Œ (ê±´ì „í•œ ì‰¼)',
          source: 'ì°¨íŠ¸ ë¶„ì„',
          link: '#',
          weight: 20
        }
      ]
    },
    narrative: {
      score: 72,
      label: 'ì„œì‚¬',
      supportingReasons: [
        {
          text: 'ìµœê·¼ 7ì¼ ê´€ë ¨ ë‰´ìŠ¤ 18ê±´',
          source: 'ë„¤ì´ë²„ ê¸ˆìœµ',
          link: 'https://finance.naver.com',
          weight: 30
        },
        {
          text: 'ì •ì±… í‚¤ì›Œë“œ: ë°©ì‚° ìˆ˜ì¶œ, ì •ë¶€ ë°œí‘œ',
          source: 'ë‰´ìŠ¤ ë¶„ì„',
          link: '#',
          weight: 20
        },
        {
          text: 'ì‹¤ì  ê³µì‹œ: ìˆ˜ì£¼ 2ì¡°ì› ë°œí‘œ',
          source: 'OpenDART',
          link: 'https://dart.fss.or.kr',
          weight: 30
        }
      ]
    },
    risk: {
      score: 25,
      label: 'ë¦¬ìŠ¤í¬ (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)',
      supportingReasons: [
        {
          text: 'ê°­ ìƒìŠ¹ í›„ ë¶„ë°° ë´‰ ì—†ìŒ',
          source: 'ì°¨íŠ¸ ë¶„ì„',
          link: '#',
          weight: -40
        },
        {
          text: 'ë°©ì‚° ì„¹í„° ë‚´ 2ë²ˆì§¸ ê¸‰ë“± (ì„ ë„ì£¼ ìœ„ì¹˜)',
          source: 'ì„¹í„° ë¶„ì„',
          link: '#',
          weight: -30
        },
        {
          text: 'ì¼ í‰ê·  ê±°ë˜ëŒ€ê¸ˆ 800ì–µì› (ì¶©ë¶„í•œ ìœ ë™ì„±)',
          source: 'KRX',
          link: 'http://data.krx.co.kr',
          weight: -30
        }
      ]
    }
  };
  
  const data = baseData[scoreType] || baseData.flow;
  
  // Devil's Advocate: ìë™ìœ¼ë¡œ ë°˜ëŒ€ ì˜ê²¬ ìƒì„±
  data.counterArguments = generateCounterArguments(scoreType, data, stock);
  
  // ì‹ ë¢°ë„ ê³„ì‚°
  data.confidence = calculateConfidence(data);
  
  return data;
}

/**
 * Devil's Advocate ë¡œì§
 * ê° ì ìˆ˜ì— ëŒ€í•œ ë°˜ëŒ€ ì˜ê²¬ ìë™ ìƒì„±
 */
function generateCounterArguments(scoreType, data, stock) {
  const arguments = {
    flow: [
      {
        text: `ê°œì¸ íˆ¬ìì ìˆœë§¤ë„ ì§€ì† (-${(Math.random() * 30 + 20).toFixed(0)}ì–µì›)`,
        impact: 'ì™¸êµ­ì¸/ê¸°ê´€ ë‹¨ë… ë§¤ìˆ˜ëŠ” ì§€ì†ì„± ë‚®ìŒ',
        severity: 'medium'
      },
      {
        text: `ê±°ë˜ëŒ€ê¸ˆ ê¸‰ì¦ì€ ë³€ë™ì„± ì¦ê°€ ì‹ í˜¸`,
        impact: 'ë‹¨ê¸° ê³¼ì—´ ê°€ëŠ¥ì„±',
        severity: 'medium'
      }
    ],
    structure: [
      {
        text: `MA20 ëŒ€ë¹„ ì´ê²©ë¥  +${(Math.random() * 10 + 5).toFixed(1)}%`,
        impact: 'ë‹¨ê¸° ì¶”ê²© ë¦¬ìŠ¤í¬',
        severity: 'low'
      },
      {
        text: `RSI ${(Math.random() * 15 + 65).toFixed(0)}`,
        impact: 'ê³¼ë§¤ìˆ˜ êµ¬ê°„ ì§„ì…',
        severity: 'medium'
      }
    ],
    narrative: [
      {
        text: 'ë‰´ìŠ¤ ê¸‰ì¦(7ì¼ 18ê±´)ì€ í…Œë§ˆì£¼ ê³¼ì—´ ì‹ í˜¸',
        impact: 'ë‹¨ê¸° ëª¨ë©˜í…€ í”¼ë¡œë„ ì¦ê°€',
        severity: 'high'
      },
      {
        text: 'ìˆ˜ì£¼ ê³µì‹œëŠ” ì´ë¯¸ ì£¼ê°€ ë°˜ì˜ (ë‹¹ì¼ +12% ê¸‰ë“±)',
        impact: 'ì¶”ê°€ ìƒìŠ¹ ëª¨ë©˜í…€ ì œí•œì ',
        severity: 'medium'
      }
    ],
    risk: [
      {
        text: 'ë¦¬ìŠ¤í¬ ì ìˆ˜ 25ì  = ë‚®ì€ ìœ„í—˜ì´ì§€ë§Œ, ê³¼ì‹  ê¸ˆì§€',
        impact: 'ì˜ˆìƒì¹˜ ëª»í•œ ì´ë²¤íŠ¸ ë°œìƒ ê°€ëŠ¥',
        severity: 'low'
      },
      {
        text: 'ì„¹í„° ë‚´ 2ë²ˆì§¸ = 1ë²ˆ ì¢…ëª© ì´íƒˆ ì‹œ ë™ë°˜ í•˜ë½',
        impact: 'ì„¹í„° ë¦¬ë” ì˜ì¡´ ë¦¬ìŠ¤í¬',
        severity: 'medium'
      }
    ]
  };
  
  return arguments[scoreType] || arguments.flow;
}

/**
 * ì§€ì§€ ê·¼ê±° ë Œë”ë§
 */
function renderSupportingReasons(reasons) {
  const container = $('#supporting-reasons');
  if (!container) return;
  
  container.innerHTML = '';
  
  reasons.forEach((reason, idx) => {
    const div = document.createElement('div');
    div.className = 'reason-item';
    div.innerHTML = `
      <div class="reason-text">${idx + 1}. ${reason.text}</div>
      <div class="reason-source">
        ì¶œì²˜: <a href="${reason.link}" target="_blank">${reason.source} ğŸ”—</a>
        ${reason.weight ? ` | ê¸°ì—¬ë„: ${Math.abs(reason.weight)}ì ` : ''}
      </div>
    `;
    container.appendChild(div);
  });
}

/**
 * ë°˜ëŒ€ ì˜ê²¬ ë Œë”ë§ (Devil's Advocate)
 */
function renderCounterArguments(arguments) {
  const container = $('#counter-reasons');
  if (!container) return;
  
  container.innerHTML = '';
  
  arguments.forEach((arg, idx) => {
    const severityColor = {
      low: '#fbbf24',
      medium: '#fb923c',
      high: '#ef4444'
    }[arg.severity];
    
    const div = document.createElement('div');
    div.className = 'reason-item counter';
    div.innerHTML = `
      <div class="reason-text">
        <span style="color:${severityColor};">âš ï¸</span> ${idx + 1}. ${arg.text}
      </div>
      <div class="reason-source">
        â†’ ${arg.impact}
      </div>
    `;
    container.appendChild(div);
  });
}

/**
 * ì‹ ë¢°ë„ ê³„ì‚°
 * ë°˜ëŒ€ ì˜ê²¬ì˜ ì‹¬ê°ë„ì— ë”°ë¼ ì‹ ë¢°ë„ ê°ì†Œ
 */
function calculateConfidence(data) {
  let confidence = data.score;
  
  // ë°˜ëŒ€ ì˜ê²¬ì´ ë§ì„ìˆ˜ë¡ ì‹ ë¢°ë„ í•˜ë½
  const severityWeight = { low: 5, medium: 10, high: 15 };
  if (data.counterArguments) {
    data.counterArguments.forEach(arg => {
      confidence -= severityWeight[arg.severity];
    });
  }
  
  // 0-100 ë²”ìœ„ ìœ ì§€
  return Math.max(0, Math.min(100, confidence));
}

// ì‚¬ìš©ì ì…ë ¥ ë³€ê²½ ì‹œ ì¬ê³„ì‚°
document.addEventListener('DOMContentLoaded', () => {
  const periodSelect = $('#plan-period');
  const riskSelect = $('#plan-risk');
  
  if (periodSelect) {
    periodSelect.addEventListener('change', updateTradePlan);
  }
  
  if (riskSelect) {
    riskSelect.addEventListener('change', updateTradePlan);
  }
});

/**
 * ì‹¤ì‹œê°„ Trade Plan ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
 * ì‚¬ìš©ìê°€ ê¸°ê°„/ë¦¬ìŠ¤í¬ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜
 */
function updateTradePlan() {
  if (!selectedStock) {
    const resultBox = $('#plan-result');
    if (resultBox) {
      resultBox.innerHTML = `
        <div class="small" style="color:var(--muted); text-align:center; padding:20px;">
          ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.
        </div>
      `;
    }
    return;
  }
  
  // í˜„ì¬ ì„ íƒëœ ì¢…ëª©ì˜ funnelType ê°€ì ¸ì˜¤ê¸°
  const funnelType = selectedStock.type || 'FOLLOWER';
  
  // buildTradePlan ì¬ì‹¤í–‰ (ê¸°ì¡´ í•¨ìˆ˜ í™œìš©)
  buildTradePlan(selectedStock, funnelType);
  
  console.log('ğŸ”„ Trade Plan updated:', {
    stock: selectedStock.name,
    period: $('#plan-period')?.value,
    risk: $('#plan-risk')?.value
  });
}

// ì‚¬ìš©ì ì…ë ¥ ë³€ê²½ ì‹œ ì¬ê³„ì‚°
document.addEventListener('DOMContentLoaded', () => {
  const periodInput = $('#plan-period');
  const riskInput = $('#plan-risk');
  
  if (periodInput && riskInput) {
    [periodInput, riskInput].forEach(input => {
      input.addEventListener('change', () => {
        if (selectedStock) {
          const funnelType = selectedStock.type || 'FOLLOWER';
          buildTradePlan(selectedStock, funnelType);
        }
      });
    });
  }
});

async function init() {
  console.log('ğŸš€ Initializing Decision Stream v4.0...');
  
  try {
    // âœ… ëª¨ë“  MARKET_DATA ì£¼ê°€ stock_prices.jsonì—ì„œ ë¡œë“œ
    await updateAllMarketDataPrices();
    
    // ìµœì‹  ì£¼ê°€ ì—…ë°ì´íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ)
    updateStockPrices().catch(err => {
      console.warn('âš ï¸ Stock price update failed (using cached prices):', err);
    });
    
    // Load data
    console.log('ğŸ“Š Loading Market Regime...');
    await loadRegime();
    
    console.log('ğŸŒ¡ï¸ Loading Sector Heatmap...');
    await loadSectors();
    
    console.log('âœ… All Data Loaded Successfully!');
  } catch (error) {
    console.error('âŒ Initialization Error:', error);
    
    // ì—ëŸ¬ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
    const regimeBadge = $('#regime-badge');
    if (regimeBadge) {
      regimeBadge.textContent = 'ì˜¤ë¥˜';
      regimeBadge.className = 'badge err';
    }
    
    const sectorList = $('#sector-list');
    if (sectorList) {
      sectorList.innerHTML = `
        <div class="alert danger" style="margin: 16px 0;">
          <strong>âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</strong><br>
          <small>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.</small><br>
          <button onclick="location.reload()" style="margin-top:8px; padding:6px 12px; background:#f56565; color:white; border:none; border-radius:4px; cursor:pointer;">
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      `;
    }
  }
}

// Run on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
