<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨íŠ¸ ë¶„ì„ | Decision Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: #e8eaed;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .search-bar input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        .search-bar button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
        }
        .chart-container {
            position: relative;
            height: 500px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }
        .stat-value.green { color: #48bb78; }
        .stat-value.red { color: #f56565; }
        .stat-value.yellow { color: #ecc94b; }
        .recommendation {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
        }
        .recommendation.buy {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid #48bb78;
            color: #48bb78;
        }
        .recommendation.sell {
            background: rgba(245, 101, 101, 0.2);
            border: 2px solid #f56565;
            color: #f56565;
        }
        .recommendation.hold {
            background: rgba(236, 201, 75, 0.2);
            border: 2px solid #ecc94b;
            color: #ecc94b;
        }
        .summary {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 14px;
            color: #cbd5e0;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #a0aec0;
        }
        .patterns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .pattern-badge {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ì°¨íŠ¸ ë¶„ì„ (ê¸°ìˆ ì  ë¶„ì„)</h1>
            <p>Yahoo Finance API - í•œêµ­/ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ì°¨íŠ¸ (15ë¶„ ì§€ì—°)</p>
        </div>

        <div class="search-bar">
            <input type="text" id="ticker-input" placeholder="ì¢…ëª©ì½”ë“œ ì…ë ¥ (í•œêµ­: 005930 / ë¯¸êµ­: AAPL)" value="AAPL">
            <button onclick="analyzeStock()">ë¶„ì„í•˜ê¸°</button>
        </div>

        <div id="loading" class="loading" style="display:none;">
            <p>ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div id="result" style="display:none;">
            <!-- ì°¨íŠ¸ & ë¶„ì„ -->
            <div class="grid">
                <!-- ì°¨íŠ¸ -->
                <div class="card">
                    <div class="card-title" id="stock-name">ì‚¼ì„±ì „ì (005930)</div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="card">
                    <div class="card-title">ê¸°ìˆ ì  ì§€í‘œ</div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-label">í˜„ì¬ê°€</div>
                            <div class="stat-value" id="current-price">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ë“±ë½ë¥ </div>
                            <div class="stat-value" id="change">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">RSI (14)</div>
                            <div class="stat-value" id="rsi">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">MACD ì‹ í˜¸</div>
                            <div class="stat-value" id="macd">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ë‹¨ê¸° ì¶”ì„¸</div>
                            <div class="stat-value" id="short-trend">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì¤‘ê¸° ì¶”ì„¸</div>
                            <div class="stat-value" id="mid-trend">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì§€ì§€ì„ </div>
                            <div class="stat-value" id="support">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì €í•­ì„ </div>
                            <div class="stat-value" id="resistance">-</div>
                        </div>
                    </div>

                    <div id="patterns-container" style="margin-top:20px;">
                        <div class="stat-label">ìº”ë“¤ íŒ¨í„´</div>
                        <div class="patterns" id="patterns"></div>
                    </div>

                    <div class="recommendation" id="recommendation">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
            </div>

            <!-- ë¶„ì„ ìš”ì•½ -->
            <div class="card">
                <div class="card-title">ğŸ“ ë¶„ì„ ìš”ì•½</div>
                <div class="summary" id="summary">-</div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;

        async function analyzeStock() {
            const ticker = document.getElementById('ticker-input').value.trim();
            if (!ticker) {
                alert('ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                // ì‹¤ì œ API í˜¸ì¶œ (í¬íŠ¸ 8126ìœ¼ë¡œ ìˆ˜ì •)
                const response = await fetch(`http://127.0.0.1:8126/api/chart/${ticker}?key=ds-test-2026`);
                
                if (!response.ok) {
                    throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                
                // ì°¨íŠ¸ ë° UI ì—…ë°ì´íŠ¸
                updateUI(data);
                
            } catch (error) {
                console.error('API Error:', error);
                console.log('âš ï¸ ì‹¤ì œ API ì—°ë™ ì‹¤íŒ¨, Mock ë°ì´í„° ì‚¬ìš©');
                
                // í´ë°±: ëª©ì—… ë°ì´í„° ì‚¬ìš©
                const mockData = generateMockData(ticker);
                updateUI(mockData);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function generateMockData(ticker) {
            const dates = [];
            const prices = [];
            const ma5 = [];
            const ma20 = [];
            const ma60 = [];
            
            // ì¢…ëª©ëª… ë§¤í•‘
            const stockNames = {
                '005930': 'ì‚¼ì„±ì „ì',
                '012450': 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤',
                '207940': 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤',
                '068270': 'ì…€íŠ¸ë¦¬ì˜¨',
                'JNJ': 'Johnson & Johnson',
                'LMT': 'Lockheed Martin',
                'NVDA': 'NVIDIA',
                'AAPL': 'Apple Inc.',
                '079550': 'LIGë„¥ìŠ¤ì›',
                '000660': 'SKí•˜ì´ë‹‰ìŠ¤',
                '042700': 'í•œë¯¸ë°˜ë„ì²´'
            };
            
            const stockName = stockNames[ticker] || ticker;
            
            // ë¯¸êµ­ ì£¼ì‹ì¸ì§€ í™•ì¸ (ì•ŒíŒŒë²³ í‹°ì»¤)
            const isUS = ticker.length <= 5 && /^[A-Z]+$/.test(ticker);
            
            const basePrice = ticker === '005930' ? 75000 : 
                            ticker === '012450' ? 185000 :
                            ticker === '207940' ? 850000 :
                            ticker === '068270' ? 175000 :
                            ticker === 'JNJ' ? 215 :
                            ticker === 'LMT' ? 445 :
                            ticker === 'NVDA' ? 188 :
                            ticker === 'AAPL' ? 264 :
                            ticker === '079550' ? 544000 :
                            ticker === '000660' ? 142000 :
                            ticker === '042700' ? 95000 :
                            isUS ? 150 :  // ê¸°ë³¸ ë¯¸êµ­ ì£¼ì‹ ê°€ê²©
                            100000;        // ê¸°ë³¸ í•œêµ­ ì£¼ì‹ ê°€ê²©
            let currentPrice = basePrice;
            
            for (let i = 0; i < 120; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (120 - i));
                dates.push(date.toISOString().split('T')[0]);
                
                currentPrice += (Math.random() - 0.5) * (basePrice * 0.02);
                prices.push(currentPrice);
                
                if (i >= 4) ma5.push(prices.slice(i-4, i+1).reduce((a,b) => a+b) / 5);
                else ma5.push(null);
                
                if (i >= 19) ma20.push(prices.slice(i-19, i+1).reduce((a,b) => a+b) / 20);
                else ma20.push(null);
                
                if (i >= 59) ma60.push(prices.slice(i-59, i+1).reduce((a,b) => a+b) / 60);
                else ma60.push(null);
            }
            
            const currentPriceValue = prices[prices.length - 1];
            const prevPrice = prices[prices.length - 2];
            const change = ((currentPriceValue - prevPrice) / prevPrice * 100);
            
            return {
                ticker: ticker,
                name: stockName,
                dates: dates,
                prices: prices,
                ma5: ma5,
                ma20: ma20,
                ma60: ma60,
                indicators: {
                    current_price: currentPriceValue,
                    rsi: 55 + Math.random() * 20,
                    macd: Math.random() > 0.5 ? 'ë§¤ìˆ˜' : 'ì¤‘ë¦½',
                    short_trend: 'ìƒìŠ¹',
                    mid_trend: 'ìƒìŠ¹',
                    support: Math.min(...prices.slice(-20)),
                    resistance: Math.max(...prices.slice(-20)),
                    patterns: ['Bullish Engulfing', 'Hammer']
                },
                signal: 'BUY',
                summary: `${stockName} Mock ì°¨íŠ¸ ë¶„ì„\n\në‹¨ê¸° ì¶”ì„¸: ìƒìŠ¹\nì¤‘ê¸° ì¶”ì„¸: ìƒìŠ¹\nRSI: ì¤‘ë¦½ê¶Œ\nMACD: ë§¤ìˆ˜ ì‹ í˜¸\n\ní˜„ì¬ ìƒìŠ¹ ì¶”ì„¸ë¥¼ ë³´ì´ê³  ìˆìœ¼ë©°, ê¸°ìˆ ì  ì§€í‘œìƒ ë§¤ìˆ˜ ê³ ë ¤ ê°€ëŠ¥`
            };
        }

        function updateUI(data) {
            document.getElementById('result').style.display = 'block';
            
            // í†µí™” ì •ë³´ (APIì—ì„œ ì œê³µ)
            const currency = data.currency || 'KRW';
            const currencySymbol = currency === 'USD' ? '$' : 'â‚©';
            const isUS = currency === 'USD';
            
            // ì¢…ëª©ëª… (ë°ì´í„°ì— ì—†ìœ¼ë©´ ì¢…ëª©ì½”ë“œ ì‚¬ìš©)
            const stockName = data.name || data.ticker;
            document.getElementById('stock-name').textContent = `${stockName} (${data.ticker})`;
            
            // í˜„ì¬ê°€ ë° ë³€ë™ë¥ 
            const currentPrice = data.indicators.current_price || data.prices[data.prices.length - 1];
            const prevPrice = data.prices && data.prices.length > 1 ? data.prices[data.prices.length - 2] : currentPrice * 0.99;
            const change = ((currentPrice - prevPrice) / prevPrice * 100);
            
            const priceDisplay = isUS ? `${currencySymbol}${currentPrice.toFixed(2)}` : `${currencySymbol}${Math.round(currentPrice).toLocaleString()}`;
            document.getElementById('current-price').textContent = priceDisplay;
            document.getElementById('change').textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
            document.getElementById('change').className = `stat-value ${change > 0 ? 'green' : 'red'}`;
            
            // RSI
            document.getElementById('rsi').textContent = data.indicators.rsi.toFixed(1);
            document.getElementById('rsi').className = data.indicators.rsi > 70 ? 'stat-value red' : 
                                                        data.indicators.rsi < 30 ? 'stat-value green' : 
                                                        'stat-value yellow';
            
            // MACD
            document.getElementById('macd').textContent = data.indicators.macd;
            document.getElementById('macd').className = data.indicators.macd === 'ë§¤ìˆ˜' ? 'stat-value green' : 
                                                        data.indicators.macd === 'ë§¤ë„' ? 'stat-value red' : 
                                                        'stat-value yellow';
            
            // ë‹¨ê¸° ì¶”ì„¸
            document.getElementById('short-trend').textContent = data.indicators.short_trend;
            document.getElementById('short-trend').className = data.indicators.short_trend === 'ìƒìŠ¹' ? 'stat-value green' : 
                                                               data.indicators.short_trend === 'í•˜ë½' ? 'stat-value red' : 
                                                               'stat-value yellow';
            
            // ì¤‘ê¸° ì¶”ì„¸
            document.getElementById('mid-trend').textContent = data.indicators.mid_trend;
            document.getElementById('mid-trend').className = data.indicators.mid_trend === 'ìƒìŠ¹' ? 'stat-value green' : 
                                                            data.indicators.mid_trend === 'í•˜ë½' ? 'stat-value red' : 
                                                            'stat-value yellow';
            
            // ì§€ì§€ì„  / ì €í•­ì„ 
            const supportDisplay = isUS ? `${currencySymbol}${data.indicators.support.toFixed(2)}` : `${currencySymbol}${Math.round(data.indicators.support).toLocaleString()}`;
            const resistanceDisplay = isUS ? `${currencySymbol}${data.indicators.resistance.toFixed(2)}` : `${currencySymbol}${Math.round(data.indicators.resistance).toLocaleString()}`;
            document.getElementById('support').textContent = supportDisplay;
            document.getElementById('resistance').textContent = resistanceDisplay;
            
            // ìº”ë“¤ íŒ¨í„´
            const patternsContainer = document.getElementById('patterns');
            if (data.indicators.patterns && data.indicators.patterns.length > 0) {
                patternsContainer.innerHTML = data.indicators.patterns.map(p => 
                    `<span class="pattern-badge">${p}</span>`
                ).join('');
            } else {
                patternsContainer.innerHTML = '<span class="pattern-badge">íŒ¨í„´ ì—†ìŒ</span>';
            }
            
            // ì¶”ì²œ
            const rec = document.getElementById('recommendation');
            rec.textContent = data.signal === 'BUY' ? 'âœ… ë§¤ìˆ˜' : 
                             data.signal === 'SELL' ? 'ğŸš« ë§¤ë„' : 
                             data.signal === 'HOLD' ? 'â¸ï¸ ê´€ë§' :
                             'â¸ï¸ ì¤‘ë¦½';
            rec.className = `recommendation ${(data.signal || 'neutral').toLowerCase()}`;
            
            // ìš”ì•½
            document.getElementById('summary').textContent = data.summary;
            
            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            drawChart(data);
        }

        function drawChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // ë¯¸êµ­ ì£¼ì‹ íŒë³„
            const isUS = data.ticker.length <= 4 && !/^\d+$/.test(data.ticker);
            const currencySymbol = isUS ? '$' : 'â‚©';
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            label: 'ì¢…ê°€',
                            data: data.prices,
                            borderColor: '#666666',
                            backgroundColor: 'rgba(102, 102, 102, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'MA5',
                            data: data.ma5,
                            borderColor: '#ff0000',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'MA20',
                            data: data.ma20,
                            borderColor: '#ffff00',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'MA60',
                            data: data.ma60,
                            borderColor: '#00ff00',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e8eaed'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const formattedValue = isUS 
                                            ? currencySymbol + context.parsed.y.toFixed(2)
                                            : currencySymbol + Math.round(context.parsed.y).toLocaleString();
                                        label += formattedValue;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: '#e8eaed',
                                callback: function(value) {
                                    return isUS 
                                        ? currencySymbol + value.toFixed(2)
                                        : currencySymbol + Math.round(value).toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e8eaed'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ìë™ ë¶„ì„
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const ticker = urlParams.get('ticker');
            
            if (ticker) {
                // URLì—ì„œ ë°›ì€ ì¢…ëª© ì½”ë“œ ì…ë ¥
                document.getElementById('ticker-input').value = ticker;
            } else {
                // ê¸°ë³¸ê°’: ì‚¼ì„±ì „ì
                document.getElementById('ticker-input').value = '005930';
            }
            
            // ìë™ìœ¼ë¡œ ë¶„ì„ ì‹œì‘
            analyzeStock();
        });
    </script>
</body>
</html>
