<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨íŠ¸ ë¶„ì„ | Decision Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: #e8eaed;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .search-bar input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        .search-bar button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
        }
        .chart-container {
            position: relative;
            height: 500px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }
        .stat-value.green { color: #48bb78; }
        .stat-value.red { color: #f56565; }
        .stat-value.yellow { color: #ecc94b; }
        .recommendation {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
        }
        .recommendation.buy {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid #48bb78;
            color: #48bb78;
        }
        .recommendation.sell {
            background: rgba(245, 101, 101, 0.2);
            border: 2px solid #f56565;
            color: #f56565;
        }
        .recommendation.hold {
            background: rgba(236, 201, 75, 0.2);
            border: 2px solid #ecc94b;
            color: #ecc94b;
        }
        .summary {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 14px;
            color: #cbd5e0;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #a0aec0;
        }
        .patterns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .pattern-badge {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ì°¨íŠ¸ ë¶„ì„ (ê¸°ìˆ ì  ë¶„ì„)</h1>
            <p>Yahoo Finance API - í•œêµ­/ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ì°¨íŠ¸ (15ë¶„ ì§€ì—°)</p>
        </div>

        <div class="search-bar">
            <input type="text" id="ticker-input" placeholder="ì¢…ëª©ì½”ë“œ ì…ë ¥ (í•œêµ­: 005930 / ë¯¸êµ­: AAPL)" value="AAPL">
            <button onclick="analyzeStock()">ë¶„ì„í•˜ê¸°</button>
        </div>

        <div id="loading" class="loading" style="display:none;">
            <p>ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div id="result" style="display:none;">
            <!-- ì°¨íŠ¸ & ë¶„ì„ -->
            <div class="grid">
                <!-- ì°¨íŠ¸ -->
                <div class="card">
                    <div class="card-title" id="stock-name">ì‚¼ì„±ì „ì (005930)</div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="card">
                    <div class="card-title">ê¸°ìˆ ì  ì§€í‘œ</div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-label">í˜„ì¬ê°€</div>
                            <div class="stat-value" id="current-price">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ë“±ë½ë¥ </div>
                            <div class="stat-value" id="change">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">RSI (14)</div>
                            <div class="stat-value" id="rsi">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">MACD ì‹ í˜¸</div>
                            <div class="stat-value" id="macd">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ë‹¨ê¸° ì¶”ì„¸</div>
                            <div class="stat-value" id="short-trend">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì¤‘ê¸° ì¶”ì„¸</div>
                            <div class="stat-value" id="mid-trend">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì§€ì§€ì„ </div>
                            <div class="stat-value" id="support">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ì €í•­ì„ </div>
                            <div class="stat-value" id="resistance">-</div>
                        </div>
                    </div>

                    <div id="patterns-container" style="margin-top:20px;">
                        <div class="stat-label">ìº”ë“¤ íŒ¨í„´</div>
                        <div class="patterns" id="patterns"></div>
                    </div>

                    <div class="recommendation" id="recommendation">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
            </div>

            <!-- ë¶„ì„ ìš”ì•½ -->
            <div class="card">
                <div class="card-title">ğŸ“ ë¶„ì„ ìš”ì•½</div>
                <div class="summary" id="summary">-</div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;

        async function analyzeStock() {
            const ticker = document.getElementById('ticker-input').value.trim();
            if (!ticker) {
                alert('ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                // ì‹¤ì œ API í˜¸ì¶œ - ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (CORS ë¬¸ì œ í•´ê²°)
                console.log(`ğŸ“Š ì°¨íŠ¸ ë¶„ì„: ${ticker} API í˜¸ì¶œ...`);
                const apiUrl = `/api/chart/${ticker}`;
                console.log(`API URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log(`Response status: ${response.status}`);
                console.log(`Response headers:`, response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € í™•ì¸
                const responseText = await response.text();
                console.log(`ğŸ“„ Raw Response Text:`, responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError.message);
                    console.error('ì‘ë‹µ ë‚´ìš©:', responseText);
                    throw parseError;
                }
                
                console.log(`âœ… API ì„±ê³µ: ${ticker} ë°ì´í„° ë°›ìŒ`, data);
                
                // ì°¨íŠ¸ ë° UI ì—…ë°ì´íŠ¸
                updateUI(data);
                
            } catch (error) {
                console.error('âŒ API Error:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                // ì—ëŸ¬ ìƒì„¸ ì •ë³´ ì¶œë ¥
                console.error(`ìƒì„¸ ì—ëŸ¬:
- Ticker: ${ticker}
- API URL: /api/chart/${ticker}
- ì—ëŸ¬ íƒ€ì…: ${error.constructor.name}
- ì—ëŸ¬ ë©”ì‹œì§€: ${error.message}`);
                
                // Mock ë°ì´í„° ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ì—ëŸ¬ í‘œì‹œ
                document.getElementById('result').innerHTML = `
                    <div style="padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 8px;">
                        <h3 style="color: #c00; margin-top: 0;">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>
                        <p><strong>ì¢…ëª©:</strong> ${ticker}</p>
                        <p><strong>ì—ëŸ¬:</strong> ${error.message}</p>
                        <p style="font-size: 13px; color: #666;">
                            <strong>í•´ê²° ë°©ë²•:</strong><br>
                            1. F12 ê°œë°œì ë„êµ¬ ì—´ê¸°<br>
                            2. Console íƒ­ì—ì„œ ì—ëŸ¬ í™•ì¸<br>
                            3. Network íƒ­ì—ì„œ /api/chart/${ticker} ì‘ë‹µ í™•ì¸<br>
                            4. ì„œë²„ ìƒíƒœ: <a href="http://localhost:8000/api/price/${ticker}" target="_blank">API í…ŒìŠ¤íŠ¸</a>
                        </p>
                    </div>
                `;
                document.getElementById('result').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateUI(data) {
            document.getElementById('result').style.display = 'block';
            
            // í†µí™” ì •ë³´ (APIì—ì„œ ì œê³µ)
            const currency = data.currency || 'KRW';
            const currencySymbol = currency === 'USD' ? '$' : 'â‚©';
            const isUS = currency === 'USD';
            
            // ì¢…ëª©ëª… (ë°ì´í„°ì— ì—†ìœ¼ë©´ ì¢…ëª©ì½”ë“œ ì‚¬ìš©)
            const stockName = data.name || data.ticker;
            document.getElementById('stock-name').textContent = `${stockName} (${data.ticker})`;
            
            // í˜„ì¬ê°€ ë° ë³€ë™ë¥ 
            const currentPrice = data.indicators.current_price || data.prices[data.prices.length - 1];
            const prevPrice = data.prices && data.prices.length > 1 ? data.prices[data.prices.length - 2] : currentPrice * 0.99;
            const change = ((currentPrice - prevPrice) / prevPrice * 100);
            
            const priceDisplay = isUS ? `${currencySymbol}${currentPrice.toFixed(2)}` : `${currencySymbol}${Math.round(currentPrice).toLocaleString()}`;
            document.getElementById('current-price').textContent = priceDisplay;
            document.getElementById('change').textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
            document.getElementById('change').className = `stat-value ${change > 0 ? 'green' : 'red'}`;
            
            // RSI
            document.getElementById('rsi').textContent = data.indicators.rsi.toFixed(1);
            document.getElementById('rsi').className = data.indicators.rsi > 70 ? 'stat-value red' : 
                                                        data.indicators.rsi < 30 ? 'stat-value green' : 
                                                        'stat-value yellow';
            
            // MACD
            document.getElementById('macd').textContent = data.indicators.macd;
            document.getElementById('macd').className = data.indicators.macd === 'ë§¤ìˆ˜' ? 'stat-value green' : 
                                                        data.indicators.macd === 'ë§¤ë„' ? 'stat-value red' : 
                                                        'stat-value yellow';
            
            // ë‹¨ê¸° ì¶”ì„¸
            document.getElementById('short-trend').textContent = data.indicators.short_trend;
            document.getElementById('short-trend').className = data.indicators.short_trend === 'ìƒìŠ¹' ? 'stat-value green' : 
                                                               data.indicators.short_trend === 'í•˜ë½' ? 'stat-value red' : 
                                                               'stat-value yellow';
            
            // ì¤‘ê¸° ì¶”ì„¸
            document.getElementById('mid-trend').textContent = data.indicators.mid_trend;
            document.getElementById('mid-trend').className = data.indicators.mid_trend === 'ìƒìŠ¹' ? 'stat-value green' : 
                                                            data.indicators.mid_trend === 'í•˜ë½' ? 'stat-value red' : 
                                                            'stat-value yellow';
            
            // ì§€ì§€ì„  / ì €í•­ì„ 
            const supportDisplay = isUS ? `${currencySymbol}${data.indicators.support.toFixed(2)}` : `${currencySymbol}${Math.round(data.indicators.support).toLocaleString()}`;
            const resistanceDisplay = isUS ? `${currencySymbol}${data.indicators.resistance.toFixed(2)}` : `${currencySymbol}${Math.round(data.indicators.resistance).toLocaleString()}`;
            document.getElementById('support').textContent = supportDisplay;
            document.getElementById('resistance').textContent = resistanceDisplay;
            
            // ìº”ë“¤ íŒ¨í„´
            const patternsContainer = document.getElementById('patterns');
            if (data.indicators.patterns && data.indicators.patterns.length > 0) {
                patternsContainer.innerHTML = data.indicators.patterns.map(p => 
                    `<span class="pattern-badge">${p}</span>`
                ).join('');
            } else {
                patternsContainer.innerHTML = '<span class="pattern-badge">íŒ¨í„´ ì—†ìŒ</span>';
            }
            
            // ì¶”ì²œ
            const rec = document.getElementById('recommendation');
            rec.textContent = data.signal === 'BUY' ? 'âœ… ë§¤ìˆ˜' : 
                             data.signal === 'SELL' ? 'ğŸš« ë§¤ë„' : 
                             data.signal === 'HOLD' ? 'â¸ï¸ ê´€ë§' :
                             'â¸ï¸ ì¤‘ë¦½';
            rec.className = `recommendation ${(data.signal || 'neutral').toLowerCase()}`;
            
            // ìš”ì•½
            document.getElementById('summary').textContent = data.summary;
            
            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            drawChart(data);
        }

        function drawChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // ë¯¸êµ­ ì£¼ì‹ íŒë³„
            const isUS = data.ticker.length <= 4 && !/^\d+$/.test(data.ticker);
            const currencySymbol = isUS ? '$' : 'â‚©';
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            label: 'ì¢…ê°€',
                            data: data.prices,
                            borderColor: '#666666',
                            backgroundColor: 'rgba(102, 102, 102, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'MA5',
                            data: data.ma5,
                            borderColor: '#ff0000',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'MA20',
                            data: data.ma20,
                            borderColor: '#ffff00',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'MA60',
                            data: data.ma60,
                            borderColor: '#00ff00',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e8eaed'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const formattedValue = isUS 
                                            ? currencySymbol + context.parsed.y.toFixed(2)
                                            : currencySymbol + Math.round(context.parsed.y).toLocaleString();
                                        label += formattedValue;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: '#e8eaed',
                                callback: function(value) {
                                    return isUS 
                                        ? currencySymbol + value.toFixed(2)
                                        : currencySymbol + Math.round(value).toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e8eaed'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ìë™ ë¶„ì„
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const ticker = urlParams.get('ticker');
            
            if (ticker) {
                // URLì—ì„œ ë°›ì€ ì¢…ëª© ì½”ë“œ ì…ë ¥
                document.getElementById('ticker-input').value = ticker;
            } else {
                // ê¸°ë³¸ê°’: ì‚¼ì„±ì „ì
                document.getElementById('ticker-input').value = '005930';
            }
            
            // ìë™ìœ¼ë¡œ ë¶„ì„ ì‹œì‘
            analyzeStock();
        });
    </script>
</body>
</html>
